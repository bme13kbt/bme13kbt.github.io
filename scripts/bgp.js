function bevgeoplot(h,S){function z(){Ni=document.getElementById(h).offsetWidth,_i=document.getElementById(h).offsetHeight}function F(){}function D(){$s.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),$s.get('press').set({threshold:50,time:3}),$s.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),$s.get('pinch').set({enable:!0})}function Q(Mn,Cn){var Rn=null==Cn?Vl:Cn;if(null==Mn)return console.log('Null object!'),null;for(var Jn,Ln=0;Ln<Rn.children.length;Ln++)if(Rn.children[Ln].uuid==Mn){Jn=Rn.children[Ln];break}return Jn}function V(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,hi.visible=!1,Il=yp=zp=-1e3,ln=-1e3,renderblock=1;for(var Mn=0;Mn<oman.ao.length;Mn++)oman.removefromscene(oman.get(Mn));_l=[],oman=new M,ba(),allp=new Ge,allq=new We,Sa(),allq.update(),renderblock=0,$()}function M(){this.ao=_l,this.history=[],this.sid=hl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Mn){this.changelist[Mn]=hl},this.select=function(Mn,Cn){this.so=null,this.sp=null,this.selidx=null;var Rn=me(Mn,Cn);if(Rn[3]>Math.sqrt(Ci*Ci+Mi*Mi)/7)return console.log('Nothing selected'),[null,null];var Jn=Rn[0];return this.selidx=Jn,this.so=this.get(Jn),this.so||console.log('No object selected'),this.sp=allp.par[Le(Jn)],this.sp||console.log('No property selected'),gi.visible=!!this.so,[this.so,this.sp]},this.get=function(Mn){var Cn=this.ao[Mn];return null==Cn?(console.log('No object ',Mn),null):Cn},this.add=function(Mn){this.ao.push(Mn)},this.undo=function(){var Mn=this.history.pop();return Mn?void('add'==Mn[0]&&(this.removefromscene(Mn[1]),this.history.pop()),'remove'==Mn[0]&&(this.plot(Mn[1]),this.history.pop()),'removeSequence'==Mn[0]&&(this.plot(Mn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Mn[0]&&this.move(Mn[1],Mn[2],Mn[3]),Sa(),$()):void console.log('No history elements')},this.move=function(Mn,Cn,Rn){if(null==Mn)return void console.log('Trying to move null object');var Jn=Q(Mn.id,'B'==Mn.type?vi:null);if(Jn){var Ln=Cn-Mn.xs,jn=Rn-Mn.ys;Jn.position.x+=Ln,Jn.position.y+=jn,params.movestart||this.history.push(['movefrom',Mn,Mn.xs,Mn.ys]),Mn.xs=Cn,Mn.ys=Rn,gi.visible=!0,gi.position.set(Cn,Rn,10),this.updchangelist(Mn.sid)}},this.erasefromhistory=function(Mn){for(var Cn=0;Cn<this.history.length;Cn)this.history[Cn][1].sameas(Mn)?this.history.splice(Cn,1):Cn++},this.removefromscene=function(Mn,Cn){if(1==Mn.skip)return!1;if('L'==Mn.type)return Mn.skip=1,Cn?this.history.push(['removeSequence',Mn]):this.history.push(['remove',Mn]),renderblock||this.updchangelist(Mn.sid),!0;var Rn=Q(Mn.id,'B'==Mn.type?vi:null);return null==Rn?(console.log('No such object on scene',Mn),!1):('B'==Mn.type?vi.remove(Rn):Vl.remove(Rn),this.history.push(['remove',Mn]),$(),Mn.skip=1,renderblock||this.updchangelist(Mn.sid),!0)},this.isdublicate=function(Mn){for(var Rn,Cn=0;Cn<this.ao.length;Cn++)Rn=this.get(Cn),Rn.sameas(Mn)&&(this.removefromscene(Rn),this.erasefromhistory(Mn))},this.plot=function(Mn){if('L'==Mn.type)return Mn.skip=0,void this.history.push(['add',Mn]);var Cn;'W'==Mn.type&&(Cn=W(Mn.xs,Mn.ys,Mn.zs,Mn.size)),'F'==Mn.type&&(Cn=Z(Mn.xs,Mn.ys,Mn.zs,Mn.angle,Mn.fall,Mn.size),''!=Mn.color&&Ut(Mn.color)),'T'==Mn.type&&(Cn=U(Mn.text,Mn.xs,Mn.ys,Mn.zs,1- -Mn.fall)),'B'==Mn.type&&(Cn=E(Mn.xs,Mn.ys,Mn.zs,Mn.xe,Mn.ye,Mn.ze),li=[Cn,Mn],vi.add(Cn));Cn&&(Cn.name=_l.length,Mn.id=Cn.uuid,Mn.skip=0,this.history.push(['add',Mn]),'B'!=Mn.type&&Vl.add(Cn),$())}}function C(Mn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(en=Mn.center.x-Hi,lasty=Mn.center.y-Ui),Cl.x=2*((Mn.center.x-Hi)/Ni)-1,Cl.y=2*-((Mn.center.y-Ui)/_i)+1,Sl?R():J())}function R(){fcp=1,Ml.setFromCamera(Cl,camera);var Mn=Ml.intersectObjects(meshes.children);if(0<Mn.length){var Cn=new Ma;Cn.sid=hl;var Rn=mr(Il),Jn=mr(yp),Ln=mr(zp),jn=mr(Gl),Pn=mr(yp2d),An=mr(Mn[0].point.x),En=mr(Mn[0].point.y),Tn=mr(Mn[0].point.z),On=mr(2*(Mn[0].uv.x-0.5)*Mi),Bn=mr(2*(Mn[0].uv.y-0.5)*Ci);if(-1e3<Il){var In=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Gn=In+params.color,Nn=G(Rn,Jn,Ln,An,En,Tn,Math.round(40*params.size),params.color);if(2==Mn.length){var _n=mr(2*(Mn[1].uv.x-0.5)*Mi),Wn=mr(2*(Mn[1].uv.y-0.5)*Ci),Un={xs:_n,ys:Wn,v:new THREE.Vector3(Mn[1].point.x,Mn[1].point.y,Mn[1].point.z)};linez.push(Un)}var Un={xs:jn,ys:Pn,v:new THREE.Vector3(Rn,Jn,Ln)};linez.push(Un),line3dtemp.add(Nn)}Il=An,yp=En,zp=Tn,Gl=On,yp2d=Bn,zp2d=Tn}$()}function J(){fcp=1,Ml.setFromCamera(Cl,camera);var Mn=Ml.intersectObjects(Nl);if(0<Mn.length){var Cn=new Ma;Cn.sid=hl;var Rn=mr(Il),Jn=mr(yp),Ln=mr(zp),jn=mr(Mn[0].point.x),Pn=mr(Mn[0].point.y),An=mr(Mn[0].point.z);if(!Sl&&jn<-Mi)return Pe(Pn),params.linetype='Select',Ae(),void $();if('Line'==params.linetype){if(-1e3<Il){hi.visible=!0,hi.position.set(jn,Pn,10);var En=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Tn=En+params.color,On=G(Rn,Jn,Ln,jn,Pn,An+params.layer+1,Math.round(30*params.size),params.color);On.name=_l.length,Cn.addline(Rn,Jn,Ln,jn,Pn,An+params.layer+1,Math.round(30*params.size),Tn),oman.plot(Cn),oman.add(Cn),yi.add(On),ln=jn,endy=Pn}else tn=jn,firsty=Pn,firstz=An;hi.visible=!0,hi.position.set(jn,Pn,10),Il=jn,yp=Pn,zp=An+params.layer+1}if('Bolt'==params.linetype)if(!Ll)Cn.addbolt(jn,Pn,An+7,jn,Pn,An+7,params.bolttype),oman.plot(Cn),oman.add(Cn);else{B(jn,Pn,An+7);var Bn=oman.get(_l.length-1);Bn.xe=Xl.vertices[1].x,Bn.ye=Xl.vertices[1].y,Bn.ze=Xl.vertices[1].z}if('Fall'==params.linetype&&(jl?0!=params.fall&&Oa(jn,Pn,An+7):(Cn.addfall(jn,Pn,An+7,params.angle,params.fall,gl<yl),oman.plot(Cn),oman.add(Cn))),'Water'==params.linetype&&(Cn.addwater(jn,Pn,An+7,Math.round(10*params.wsize)/10),oman.plot(Cn),oman.add(Cn)),'Text'==params.linetype&&(Cn.addtext(params.text,jn,Pn,An+params.layer+1),oman.plot(Cn),oman.add(Cn)),'Select'==params.linetype)if(!params.move){oman.select(jn,Pn);var In=me(jn,Pn);if(In[3]>Math.sqrt(Ci*Ci+Mi*Mi)/7)return;gi.visible=!0,gi.position.set(In[1],In[2],10),Di=In[0],Je(Di)}else if(oman.so){var Gn=jn-0.1*Mi/camera.zoom,Nn=Pn+0.1*Ci/camera.zoom;oman.move(oman.get(Di),Gn,Nn)}}else'Select'==params.linetype?params.move&&oe():(Ta(),gi.visible=!1);$()}function L(){if(-1e3<ln){var Mn=new Ma;Mn.sid=hl;var Cn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Cn)return void(ln=endy=tn=firsty=firstz=-1e3);var Rn=Cn+params.color;Mn.addline(ln,endy,firstz+params.layer+1,tn,firsty,firstz+params.layer+1,Math.round(30*params.size),Rn),oman.plot(Mn),oman.add(Mn),ln=endy=tn=firsty=firstz=-1e3,Sa(),$()}}function P(Mn,Cn,Rn){Vl.remove(bi);var Jn=6,Ln=0.1*Li;bi=new THREE.Object3D;var jn=-Ci,Pn=Ci,An=G(1.13*Mi,jn,0,1.13*Mi,Pn,0,10,Ha);bi.add(An);var En={val:15},Tn=U(Mn,1.13*Mi+0.11*Mi,jn+Ln,0,0,Ha);bi.add(Tn);var On=G(1.13*Mi,jn,0,1.067*Mi,jn,0,Jn,Ha);bi.add(On);var Bn=G(1.13*-Mi,jn,10,1.067*-Mi,jn,10,Jn,Ha);bi.add(Bn);var In=U(Cn,1.13*Mi+0.11*Mi,Pn-Ln,0,0,Ha);bi.add(In);var Gn=G(1.13*Mi,Pn,0,1.067*Mi,Pn,0,Jn,Ha),Nn=G(1.13*-Mi,Pn,10,1.067*-Mi,Pn,10,Jn,Ha);bi.add(Gn),bi.add(Nn);for(var _n=1;_n<pmult*(Cn-Mn)/5;++_n){var Wn=-Ci+5*(pmult*_n*(Pn-jn))/(Cn-Mn),Un=G(1.13*Mi,Wn,0,1.067*Mi,Wn,0,Jn,Ha),Hn=G(1.13*-Mi,Wn,10,1.067*-Mi,Wn,10,Jn,Ha),Xn=5*pmult*_n+parseInt(Mn),Yn=U(Xn,1.13*Mi+0.11*Mi,Wn,0,0,Ha);bi.add(Un),bi.add(Yn),bi.add(Hn)}var Kn=normPel(Mn,Cn);if(100<Kn[1]-Kn[0])for(var _n=Kn[0]-1;_n<=Kn[1];_n++)if(0==_n%100){fcp=1;var Zn=U(_n,4*Mi,Ca(_n),En,0,Ha);bi.add(Zn),fcp=0}if(null!=Rn){bi.position.set(0,Rn,0)}Vl.add(bi)}function E(Mn,Cn,Rn,Jn,Ln,jn){var Pn=new THREE.Object3D,An=0.07,En=G(Mn+An,Cn+An,Rn,Mn-An,Cn-An,Rn-0.01,2,'#000000'),Tn=G(Mn-An,Cn+An,Rn,Mn+An,Cn-An,Rn-0.01,2,'#000000'),On=Ba(Mn,Cn,Rn,2*(An/Math.sqrt(2)),2,'#000000');return ii=O(Mn,Cn,Rn,Jn,Ln,jn,1,'#000000'),Pn.add(En),Pn.add(Tn),Pn.add(On),Pn.add(ii),Pn}function T(){return 1/2e3}function O(Mn,Cn,Rn,Jn,Ln,jn,Pn,An){Xl=new THREE.Geometry,Yl=new THREE.Vector3(Mn,Cn,Rn),Xl.vertices.push(Yl),Xl.vertices.push(new THREE.Vector3(Jn,Ln,jn));return I([Mn,Cn,Rn,Jn,Ln,jn],10,An)}function B(Mn,Cn,Rn){var Jn=(Yl.x-Mn)*(Yl.x-Mn)+(Yl.y-Cn)*(Yl.y-Cn),Ln=2*(vl/Vi),jn=params.boltlen*Math.sin(Math.PI/24);if(Jn=Math.sqrt(Jn)/Ln,Jn<jn)li[0].remove(ii),ii=O(Yl.x,Yl.y,Yl.z,Mn,Cn,Rn,1,'#000000'),li[0].add(ii),li[1].xe=Mn,li[1].ye=Cn,li[1].ze=Rn;else{var An,En;An=Yl.x+(Mn-Yl.x)/Jn*jn,En=Yl.y+(Cn-Yl.y)/Jn*jn,li[0].remove(ii),ii=O(Yl.x,Yl.y,Yl.z,An,En,Rn,1,'#000000'),li[0].add(ii),li[1].xe=An,li[1].ye=En,li[1].ze=Rn}console.log(li[1])}function I(Mn,Cn,Rn,Jn){if(0!=Mn.length){var Ln=new THREE.LineGeometry;Ln.setPositions(Mn);var jn=Rn+'',Pn=0;if(7<jn.length&&(Pn=jn[0],jn=jn.slice(1,8)),0<Pn){var An=N(Mn,Cn,Rn,Jn);return An}var En=Math.abs(Cn),Tn=Sl?5:3,On=new THREE.LineMaterial({color:new THREE.Color(jn),linewidth:En/3,dashed:!1}),Bn=renderer.getSize();On.resolution.set(Bn.width,Bn.height);var An=new THREE.Line2(Ln,On);return null==Jn&&fi.add(An),An}}function G(Mn,Cn,Rn,Jn,Ln,jn,Pn,An){var En=new Float32Array(6);En[0]=Mn,En[1]=Cn,En[2]=Rn,En[3]=Jn,En[4]=Ln,En[5]=jn;var Tn=I(En,Pn,An,1);return Tn}function N(Mn,Cn,Rn,Jn){if(0!=Mn.length){var Ln=Mn.length,jn=Rn+'',Pn=0;7<jn.length&&(Pn=jn[0],jn=jn.slice(1,8));for(var An=0,En=3;En<Ln;En+=3)An+=Math.sqrt((Mn[En]-Mn[En-3])*(Mn[En]-Mn[En-3])+(Mn[En+1]-Mn[En-2])*(Mn[En+1]-Mn[En-2]));var Tn=new Float32Array(Ln);iOS&&(Tn=new Float32Array(2*Ln-3));for(var En=0;En<Mn.length;En++)Tn[En]=Mn[En];if(iOS)for(var Bn,En=0;En<Ln-3;En+=3)Bn=2*Ln-3-En-3,Tn[Bn]=Mn[En],Tn[Bn+1]=Mn[En+1],Tn[Bn+2]=Mn[En+2];var In=new THREE.Color(jn),Gn=Math.abs(Cn)*T(),Nn=new MeshLineMaterial({color:In,lineWidth:Gn*lsc,useMap:!1,transparent:!!(0>Cn),opacity:0>Cn?0.6:1,resolution:Wi});if(1==Pn)var Nn=new MeshLineMaterial({color:In,lineWidth:Gn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Ls,resolution:Wi});if(2==Pn){var _n=Math.round(1.5*An);_n=1>_n?1:_n;var Nn=new MeshLineMaterial({color:In,lineWidth:Gn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(_n,1),transparent:!0,alphaMap:js,resolution:Wi})}if(3==Pn){var _n=Math.round(An);In=new THREE.Color('#aaaaaa'),_n=1>_n?1:_n;var Nn=new MeshLineMaterial({color:In,lineWidth:1.5*(Gn*lsc),useMap:!0,map:Ps,useAlphaMap:1,repeat:new THREE.Vector2(_n,1),transparent:!0,alphaMap:Ps,resolution:Wi})}var Wn=new MeshLine;Wn.setGeometry(Tn);var Un=new THREE.Mesh(Wn.geometry,Nn);return null==Jn&&fi.add(Un),Un}}function _(Mn,Cn){var Rn=new THREE.Sprite;return Rn.position.set(Mn,Cn,2),Rn.scale.set(0.4,0.4,0.4),Rn}function W(Mn,Cn,Rn,Jn){var Ln=new THREE.Sprite(dn);return Ln.position.set(Mn,Cn,Rn),Ln.scale.x=Ln.scale.y=Jn*Li,Ln}function U(Mn,Cn,Rn,Jn,Ln,jn){var Pn=10,An=new THREE.Object3D,En=Ia(Mn,jn,Jn);if(En.position.set(Cn+0.1,Rn-0.05,Pn/5),An.add(En),Ln){En.position.set(Cn+0.35,Rn-0.2,Pn/5);var Tn=0.07,On=G(-Tn,-Tn,10,Tn,Tn,10,Pn/5,'#000000'),Bn=G(Tn,-Tn,10,-Tn,Tn,10,Pn/5,'#000000');On.position.set(Cn,Rn,0),Bn.position.set(Cn,Rn,0);var In=_(Cn+0.35,Rn+0.12);In.visible=!1,An.add(On),An.add(Bn),An.add(In),2==Ln&&(In.material=fn,In.visible=!0,console.log('photo added')),3==Ln&&(In.material=yn,In.visible=!0,console.log('labtest added'))}return An}function H(Mn){var Cn=new FileReader;Cn.onloadend=function(Rn){var Jn=gl;Re()&&(Jn=Math.round(Ra(_l[Di].ys)));var Ln=new Date,jn='';jn='pic_'+Jn+'_'+Ln.getMinutes()+'m'+Ln.getSeconds()+'s',bn(Rn.target.result,jn+'.jpg'),Y(Di,jn,1),ns.updateDisplay()},Cn.readAsDataURL(Mn.files[0])}function Y(Mn,Cn,Rn){var Jn=_l[Mn];if('T'!=Re(Mn))return void console.log('not T');var Ln=Vl.getObjectByName(Mn),jn=Ln.children[0];jn.redrawInterval=1,Ln.children[0].material.map.text=''+Cn,Jn.text=Cn,oman.updchangelist(Jn.sid),null!=Rn&&(1==Rn&&(Jn.fall=1,Ln.children[3].material=fn),2==Rn&&(Jn.fall=2,Ln.children[3].material=yn),Ln.children[3].visible=1),$(),setTimeout(function(){jn.redrawInterval=1e8,$()},1)}function K(Mn,Cn,Rn){var Jn=_l[Mn];if('F'!=Re(Mn))return void console.log('not F');var Ln=Jn.size&&gl<yl?Rn:360-Rn,jn=Vl.getObjectByName(Mn),Pn=jn.children[1].children[0];Pn.redrawInterval=1,0!=Cn&&90!=Cn&&(jn.children[1].children[0].material.map.text=''+Cn),jn.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Ln))/1e3,0==Cn&&(jn.children[0].material.map=hn,jn.children[1].children[0].material.map.text='',jn.children[0].material.rotation=0),90==Cn&&(jn.children[0].material.map=un,jn.children[1].children[0].material.map.text=''),0!=Cn&&90!=Cn&&(jn.children[0].material.map=cn),Jn.fall=parseInt(Cn),Jn.angle=parseInt(Rn),oman.updchangelist(Jn.sid),$(),setTimeout(function(){Pn.redrawInterval=1e8,$()},50)}function Z(Mn,Cn,Rn,Jn,Ln,jn){var Pn=jn==gl<yl?Jn:360-Jn,An='',En=new THREE.Object3D;if(0!=Ln&&90!=Ln){Kl=new THREE.SpriteMaterial({map:cn,color:16777215,rotation:-Math.PI/180*Pn});var Tn=new THREE.Sprite(Kl);An=Ln+''}if(0==Ln)var On=new THREE.SpriteMaterial({map:hn,color:16777215}),Tn=new THREE.Sprite(On);if(90==Ln){Kl=new THREE.SpriteMaterial({map:un,color:16777215,rotation:-Math.PI/180*Pn});var Tn=new THREE.Sprite(Kl)}Tn.position.set(Mn,Cn,Rn),Tn.scale.x=Tn.scale.y=0.4*Li;var Bn=U(An,Mn+0.25*Ji,Cn-0.12*Li,Rn,0);return En.add(Tn),En.add(Bn),En}function $(Mn,Cn){if(!renderblock){if(mt.start('render'),null==Mn&&controls.update(),Sl?renderer.render(pi,camera):null==Cn?renderer.render(Vl,camera):renderer.render(Cn,camera),null==Mn&&(1==rendebug&&console.log('r'),2==rendebug)){var Rn=$.caller;console.log(Rn)}var Jn=mt.end('render');'vlad_adm'==params.author&&(globgeo='Render '+Jn+'ms',lastgeo.innerHTML=globgeo)}}function ee(Mn,Cn){var Rn=Pa();if(!Rn)return void console.log('Nothing to save');var Jn=JSON.stringify(Rn),Ln=getpelrange(Jn,picparams.ps,picparams.pe);params.textsave=Jn,ns.updateDisplay();var jn=new Date,Pn='',An=getauthorandsid(Rn);Pn='pel'+Ln[0]+'_'+Ln[1]+'\''+params.tunnel+'\''+An.author+shortsid(An.sid)+'.txt',ifadm()||null!=Mn||vt(Jn,Pn);var En={name:Pn,size:Jn.length,content:Jn},Tn=elemfromfile(En),On=function(Nn){dbputreg(Nn,function(){null==Cn&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',Tn);var Bn=newdb.comparef(Tn);if(Bn){console.log('File already exists in db',Bn);var In=Tn.savedata,Gn=Bn.savedata;comparesave(In,Gn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),On(Tn))}else console.log('Adding new file to db',Tn),On(Tn);ae(Mn)}function ae(Mn){var Cn=Pa(1);if(!Cn)return void console.log('Nothing to save');var Rn=JSON.stringify(Cn),Jn=getpelrange(Rn,picparams.ps,picparams.pe);params.textsave=Rn,ns.updateDisplay();var Ln=new Date,jn='',Pn=getauthorandsid(Cn);jn='pel'+Jn[0]+'_'+Jn[1]+'\''+params.tunnel+'\''+Pn.author+shortsid(Pn.sid)+'.txt',ifadm()||null!=Mn||vt(Rn,jn);({name:jn,size:Rn.length,content:Rn});null==Mn&&download(Rn,jn)}function ie(Mn,Cn){params.withbg||(mi.visible=!1),tt();var Rn=new THREE.Scene;Rn.add(Fi),$(null,Rn),console.log('start save as image'),se(function(Jn){Vl.add(Fi),$(),se(Mn,Jn),mi.visible=!0,ut(),Sa(),$(),null!=Cn&&(params.what2plot='Geo+Q+Pel')},1)}function se(Mn,Cn){var Rn,Ln=window.devicePixelRatio;try{Rn=renderer.domElement.toDataURL('image/png');var Pn=new Image,An='For 3d'==params.what2plot?1:0,En='Only texture'==params.what2plot?1:0;Pn.onload=function(){var On=document.createElement('canvas');On.width=En?2*Fl:zl,On.height=En?2*Fl:Fl,On.width*=Ln,On.height*=Ln,On.visible=0;var Bn=On.getContext('2d');Bn.drawImage(Pn,0,0);var In=Bn.getImageData(0,0,On.width,On.height),Gn=In.data,Nn=Gn.length,_n=[];if(null!=Cn&&!Array.isArray(Cn))for(var Wn=0;Wn<Nn;Wn+=4)if(208==Gn[Wn]&&208==Gn[Wn+1]&&208==Gn[Wn+2]);else _n.push(Wn);if(null!=Cn&&!Array.isArray(Cn))return void Mn(_n);if(!params.withbg){for(var Wn=0;Wn<Nn;Wn+=4)208==Gn[Wn]&&208==Gn[Wn+1]&&208==Gn[Wn+2]&&(Gn[Wn+3]=0);if(Array.isArray(Cn))for(var Wn=0;Wn<Cn.length;Wn++)Gn[Cn[Wn]+3]=100}console.log('done pic'),In.data=Gn,Bn.putImageData(In,0,0);var Un=document.createElement('canvas');Un.visible=0;var Hn=Bn.getImageData(Fl,0,Fl+zl,Fl);Un.width=Fl,Un.height=zl;var Xn=Un.getContext('2d');if(Xn.putImageData(Hn,0,0),Rn=En?Un.toDataURL():On.toDataURL(),rl=Rn,console.log('tmp pic saved'),void 0!==Mn)return Za=Rn,void Mn();if(!An){var Yn=new Date,Kn='';Kn=Kn+'geo'+Yn.getHours()+'h'+Yn.getMinutes()+'m'+Yn.getSeconds()+'s.png',bn(Rn,Kn)}},Pn.src=Rn}catch(On){return void console.log(On)}}function oe(){if(!Jl){var Mn=Re();Mn&&('L'==Mn?myask(container,'Remove line?',function(){re(),ln=-1e3,Sa(),$()}):(re(),Sa(),$()))}}function re(){if(oman.so){allp.remove(oman.sp);var Mn=[];if(Mn=de(oman.selidx),'Group'==Ii.value&&1<Mn.length)for(var Cn=0;Cn<Mn.length;Cn++)oman.removefromscene(oman.get(Mn[Cn]),1);else oman.removefromscene(oman.so);gi.visible=!1,oman.so=null,oman.selidx=null}}function de(Mn){for(var Cn=[Mn],Rn=Mn-1;0<=Rn&&1!=_l[Rn].skip&&_l[Rn].xe==_l[Rn+1].xs&&_l[Rn].ye==_l[Rn+1].ys;Rn--)Cn.push(Rn);for(var Rn=Mn+1;Rn<_l.length&&1!=_l[Rn].skip&&_l[Rn-1].xe==_l[Rn].xs&&_l[Rn-1].ye==_l[Rn].ys;Rn++)Cn.push(Rn);return Cn.sort((Jn,Ln)=>Jn-Ln),Cn}function ue(Mn){var Cn=[];if(-1==Mn[0])return Cn;for(var Jn,Rn=0;Rn<Mn.length;Rn++)Jn=Mn[Rn],0==Rn&&(Cn.push(_l[Jn].xs),Cn.push(_l[Jn].ys)),Cn.push(_l[Jn].xe),Cn.push(_l[Jn].ye);return Cn}function he(){oman.undo(),Sa()}function ge(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Mi,this.author='V',this.sid=hl,this.lastchange=0,this.objdata=[]}function me(Mn,Cn){for(var Rn=_l.length,Jn=1e3,Ln=-1,jn=-20,Pn=-20,An=1,En=0;En<Rn;En++)if(!_l[En].skip){An=1;var Tn=_l[En].xs,On=_l[En].ys,Bn=(Mn-Tn)*(Mn-Tn)+(Cn-On)*(Cn-On);if('L'==_l[En].type){var In=fe(_l[En],Mn,Cn);Bn=In[0],Tn=In[2],On=In[3],(0>In[1]||1<In[1])&&(An=0)}Jn>=Bn&&An&&(Jn=Bn,Ln=En,jn=Tn,Pn=On)}return[Ln,jn,Pn,Math.sqrt(Jn)]}function fe(Mn,Cn,Rn){var Jn=Mn.xs,Ln=Mn.xe,jn=Mn.ys,Pn=Mn.ye,An=Math.sqrt((Ln-Jn)*(Ln-Jn)+(Pn-jn)*(Pn-jn)),On=[0,1,2,3,4],In=((Ln-Jn)*(Cn-Jn)+(Pn-jn)*(Rn-jn))/An/An,Gn=Jn+In*An*((Ln-Jn)/An),Nn=jn+In*An*((Pn-jn)/An),_n=Math.sqrt((Cn-Jn)*(Cn-Jn)+(Rn-jn)*(Rn-jn)),Wn=Math.sqrt((Cn-Ln)*(Cn-Ln)+(Rn-Pn)*(Rn-Pn)),Un=Math.sqrt((Cn-Gn)*(Cn-Gn)+(Rn-Nn)*(Rn-Nn));return On[0]=Math.sqrt((Cn-Gn)*(Cn-Gn)+(Rn-Nn)*(Rn-Nn)),be(In)||(On[0]=Math.min(_n,Wn)),On[1]=In,On[2]=Gn,On[3]=Nn,On[4]=0,0>=(Ln-Jn)*(Rn-jn)-(Pn-jn)*(Cn-Jn)&&(On[4]=1),On}function be(Mn){return 0<=Mn&&1>=Mn}function we(){localStorage.setItem('lastauthor',params.author)}function Se(Mn){var Cn=document.createElement('input');return Cn.setAttribute('class','inguib'),Cn.setAttribute('type','button'),Cn.setAttribute('value',Mn),Cn.setAttribute('id','mgb'+Mn),Cn.onclick=function(){console.log('clicked'+Mn)},Cn}function Fe(Mn){return': -1??'==Mn?'':Mn}function qe(Mn,Cn,Rn){Cn.value=Mn+Fe(': '+Rn),'-1??'!=Rn&&Cn.setAttribute('class','inguib aguibut')}function De(){qe('RQD',Fs.rqd,Ts.RQD+Ts.RQDc),qe('Jn',Fs.Jn,Ts.Jn+Ts.Jnc),qe('Jr',Fs.Jr,Ts.Jr+Ts.Jrc),qe('Ja',Fs.Ja,Ts.Ja+Ts.Jac),qe('Jw',Fs.Jw,Ts.Jw+Ts.Jwc),qe('SRF',Fs.SRF,Ts.SRF+Ts.SRFc),Ts.getQ(),'????'==Ts.Q+Ts.class?Fs.Q.name('Q = ?'):Fs.Q.name('Q = '+Ts.Q+Ts.class),ns.updateDisplay()}function Qe(Mn,Cn){var Rn=Mn.add(params,'dummy').name(Cn).__li;return Rn.setAttribute('class','cr function myguibut'),null==Cn&&Rn.removeChild(Rn.children[0]),Rn}function Ve(Mn){Mn.style.height='5px',Mn.style.height=Mn.scrollHeight-5+'px'}function Me(Mn,Cn){ns.add(params,'dummy').name('Geology:').onChange(function(){Ee()});var Rn=Qe(ns),Jn=Se('ShowDB');Jn.setAttribute('class','inguib but2gui'),Jn.onclick=function(){Qs.showdb()},Rn.appendChild(Jn),Jn=Se('Save'),Jn.setAttribute('class','inguib but2gui'),Jn.onclick=function(){params.save()},Rn.appendChild(Jn),fs=ns.addFolder('Save/Open file'),fs.add(params,'loadprev').name(qa.restoresession),fs.add(params,'savealpha').name(qa.savepicture),fs.add(params,'author').name(qa.author).onChange(function(){we()}).domElement.children[0].setAttribute('maxlength','20'),fs.add(params,'save').name(qa.savegeology),fs.add(params,'openfile').name(qa.openfilegeology),ifadm()&&fs.add(params,'savexml').name('Export to NovaPoint'),fs.add(params,'dummy').name('');var Ln=fs.addFolder('Expert');if(Ln.add(params,'ex').name('Expert user').onChange(function(){ns.close(),wa(Wl)}),Ln.add(params,'overridepel').name('Override pel'),Ln.add(params,'withbg').name(qa.showmwd).onChange(function(){pa()}),Ln.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),$()}),Ln.add(params,'forcesync').name('ForcedSync'),null!=Mn){if(Mn==qa.qval){ws=ns.addFolder(qa.qval);var jn=sid2txtdate(Ts.lastchange)+' by \''+Ts.author+'\'';ws.add(params,'dummy').name('Updated '+jn);var Rn=ws.add(Ts,'ps').name('Pel start').domElement.children[0];Rn.type='tel',Rn.setAttribute('maxlength','5'),Rn=ws.add(Ts,'pe').name('Pel end').domElement.children[0],Rn.type='tel',Rn.setAttribute('maxlength','5'),q22=ws.add(Ts,'comment').name('');var Pn=q22.domElement.children[0];Pn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Pn.placeholder='Comment...',Pn.onkeyup=function(){Ve(this)},20<Ts.comment.length&&Ve(Pn),Pn.onchange=function(){Te()},q22.__li.setAttribute('class','cr string bigta');var Rn=Qe(ws);Fs.rqd=Se('RQD'),Fs.rqd.onclick=function(){params.editRQD()},Rn.appendChild(Fs.rqd),Fs.Jr=Se('Jr'),Fs.Jr.onclick=function(){params.editJr()},Rn.appendChild(Fs.Jr),Fs.Jw=Se('Jw'),Fs.Jw.onclick=function(){params.editJw()},Rn.appendChild(Fs.Jw),Fs.Jn=Se('Jn'),Fs.Jn.onclick=function(){params.editJn()},Rn.appendChild(Fs.Jn),Fs.Ja=Se('Ja'),Fs.Ja.onclick=function(){params.editJa()},Rn.appendChild(Fs.Ja),Fs.SRF=Se('SRF'),Fs.SRF.onclick=function(){params.editSRF()},Rn.appendChild(Fs.SRF);var An=ws.add(params,'dummy').name('Hello');An.__li.setAttribute('class','cr function qtext'),Fs.Q=An,ws.add(Ts,'bergart',is).name(qa.rocktype);var Rn=Qe(ws),Jn=Se(qa.apply);Jn.setAttribute('class','inguib but2gui'),Jn.onclick=function(){Te()},Rn.appendChild(Jn);var Jn=Se(qa.removeq);return Jn.setAttribute('class','inguib but2gui'),Jn.onclick=function(){params.removeq()},void Rn.appendChild(Jn)}if('Select'==Mn){Ss=ns.addFolder(qa.setproperties);var jn=sid2txtdate(Os.sid)+' '+Os.author;if(Ss.add(params,'dummy').name(jn),Ss.add(Os,'author').name(qa.author),'T'!=Cn){q22=Ss.add(Os,'comment').name('');var Pn=q22.domElement.children[0];Pn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Pn.placeholder='Comment...',Pn.onkeyup=function(){Ve(this)},Pn.onchange=function(){Be()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Cn&&(Ss.add(_l[Di],'text').name(qa.text).onChange(function(){Y(Di,_l[Di].text)}),Ss.add(params,'openfoto').name(qa.takephoto),Ss.add(params,'makelab').name(qa.labtest)),null==Cn||'L'==Cn){Ss.add(Os,'bergart',is).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(Os.bergart),ns.updateDisplay()});var Rn=Ss.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(Os.bergart),ns.updateDisplay()});console.log(Rn.__li),console.log(Rn.domElement);var En=Rn.domElement.children[0];En.style.width='70%'}return'W'==Cn&&(Ss.add(Os,'dsc',qa.dsc).name(qa.description),Ss.add(Os,'wdrip').name(qa.dripmin),Ss.add(Os,'wleak').name(qa.litmin)),'F'==Cn&&(Ss.add(_l[Di],'angle',0,360).step(1).name(qa.angle).onChange(function(){K(Di,_l[Di].fall,_l[Di].angle)}),Ss.add(_l[Di],'fall',0,90).step(1).name(qa.fall).onChange(function(){K(Di,_l[Di].fall,_l[Di].angle)})),Ss.add(params,'dummy').name(''),void Ss.add(params,'applyP').name(qa.ap)}}ks=ns.addFolder(qa.main),ks.add(params,'dummy').name(''),params.ex&&(ks.add(params,'bolt').name(qa.bolt),ks.add(params,'dummy').name(''),ks.add(params,'clear').name(qa.clearall),ks.add(params,'dummy').name(''),ks.add(params,'resetcam').name(qa.resetcamera),ks.add(params,'dummy').name(''))}function Ce(Mn){for(var Cn=0;Cn<is.length;Cn++)if(Mn==is[Cn])return ss[Cn]}function Re(Mn){var Cn=0,Rn=Di;null!=Mn&&(Rn=Mn);Vl.getObjectByName(Rn);return null==_l[Rn]?Cn:1==_l[Rn].skip?Cn:_l[Rn].type}function Je(Mn){var Cn=Le(Mn);if(-3==Cn)return void console.log('Nothing selected');var Rn=Re(Mn);chosenp=Cn,-2==chosenp?(Os=new Ie,Os.type=Rn,Os.coords=El,Os.isarea=Ne(El)):Os.restore(allp.par[chosenp]),wa('Select',Rn),ns.updateDisplay()}function Le(Mn){var Cn=Re(Mn);if(!Cn)return console.log('Nothing selected'),-3;if('L'==Cn){var Rn=de(Mn);El=ue(Rn),0==El.length&&console.log('No lines selected')}else El=[_l[Mn].xs,_l[Mn].ys];return allp.get(El)}function je(Mn){for(var Cn=normPel(gl,yl),Rn=Cn[0];Rn<Cn[1];Rn+=5)if(Mn>=Rn&&Mn<Rn+5){var Jn=allq.get(Rn),Ln=allq.get(Rn+5);if(-2==Jn&&-2==Ln)return console.log('No Q near'),[Rn,Rn+5];var jn=Rn,Pn=-2==Ln?Jn:Ln;jn=-2==Ln?Math.max(allq.qar[Jn].ps,allq.qar[Jn].pe):Math.min(allq.qar[Ln].ps,allq.qar[Ln].pe);var An=-2==Ln?5:-5;return[jn,jn+An]}return console.log('No q found'),[Mn,Mn+5*Cn[2]]}function Pe(Mn){var Cn=Ra(Mn);if(Bs=allq.get(Cn),-2==Bs){Ts=new Ue,Ts.getQ();var Rn=je(Cn);Ts.ps=Rn[0],Ts.pe=Rn[1],Ts.comment=''}else Ts.restore(allq.qar[Bs]);$(),wa(qa.qval),fs.close(),ns.removeFolder(qa.main),ns.removeFolder(qa.setproperties),ws.open(),gi.visible=!0,gi.position.set(1.2*-Mi,0.35*Ca(Ts.pe)+0.65*Ca(Ts.ps),10),De(),ns.updateDisplay()}function Ae(){setTimeout(function(){ns.open()},200)}function Ee(){ns.close()}function Te(){-1<Bs?(Ts.lastchange=hl,allq.qar[Bs].restore(Ts)):(allq.add(Ts),Bs=allq.qar.length-1),oman.updchangelist(Ts.sid),allq.update(),$()}function Oe(){allq.remove(Bs),allq.update(),$(),Ts=new Ue,De()}function Be(){if(0==El.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(Os),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=hl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=Dt(Ce(Os.bergart)))}else Os.author=params.author,'L'==Os.type&&(Os.color=Dt(Ce(Os.bergart))),Os.sid=hl,allp.add(Os),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),$()}function Ie(){this.author=params.author,this.sid=hl,this.lastchange=hl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Mn){var Cn=JSON.parse(JSON.stringify(Mn));this.sid=Cn.sid,this.lastchange=null==Cn.lastchange?this.sid:Cn.lastchange,this.type=Cn.type,this.id=Cn.id,this.coords=Cn.coords,this.bergart=Cn.bergart,this.width=Cn.width,this.comment=Cn.comment,this.ispartofQ=Cn.ispartofQ,null!=Cn.author&&(this.author=Cn.author),this.isarea=Cn.isarea,this.color=Cn.color,null!=Cn.dsc&&(this.dsc=Cn.dsc,this.wdrip=Cn.wdrip,this.wleak=Cn.wleak)},this.sameas=function(Mn){if(0==Mn.length)return!1;for(var Cn=0;Cn<Math.min(Mn.length,this.coords.length)&&!(6<Cn);Cn++){if(20<Cn)return console.log('Same',this.coords),!0;if(10<Mn.length){var Rn=Va(Mn[Cn],this.coords[Cn]);if(!Rn)return!0}if(!Qa(Mn[Cn],this.coords[Cn]))return!1}return!0},this.showprops=function(){var Mn;return Mn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Mn}}function Ge(){this.par=[],this.getareas=function(){var Mn=[];for(var Cn in this.par){var Rn=this.par[Cn];Rn.isarea&&!Rn.ispartofQ&&Mn.push(Rn)}return Mn},this.amtok=function(){for(var Mn=0,Cn=0;Cn<this.par.length;Cn++)this.par[Cn].ispartofQ||Mn++;return Mn},this.add=function(Mn,Cn){var Rn=new Ie;Rn.restore(Mn),this.par.push(Rn),null==Cn&&this.update()},this.remove=function(Mn,Cn){if('object'==typeof Mn)for(var Rn in console.log('Trying to remove',Mn),this.par){var Jn=this.par[Rn];if(Jn==Mn){this.par.splice(Rn,1);break}}else-1<Mn&&this.par.splice(Mn,1);null==Cn&&this.update()},this.cleanFromQ=function(){for(var Mn=0;Mn<this.par.length;Mn++)1==this.par[Mn].ispartofQ&&(this.remove(Mn,1),Mn--)},this.y2pelcoords=function(){for(var Mn=0;Mn<this.par.length;Mn++)for(var Cn=0;Cn<this.par[Mn].coords.length;Cn+=2)this.par[Mn].coords[Cn+1]=Ra(this.par[Mn].coords[Cn+1])},this.cleanFromPel=function(){for(var Mn=0;Mn<this.par.length;Mn++)_a(this.par[Mn].coords[1])||(console.log('Skipping property',this.par[Mn]),this.remove(Mn),Mn--)},this.get=function(Mn){for(var Cn=0;Cn<this.par.length;Cn++)if(this.par[Cn].sameas(Mn))return Cn;return-2},this.restore=function(Mn,Cn,Rn){var Jn=!1;null!=Rn&&(Jn=Rn);for(var jn,Ln=0;Ln<Mn.par.length;Ln++)(jn=this.ismemberalready(Mn.par[Ln]),null==Mn.par[Ln].sid&&(Mn.par[Ln].sid=Qn),null==Mn.par[Ln].author&&(Mn.par[Ln].author=Vn),!(1==Jn&&Mn.par[Ln].sid<hl))&&(1<Jn&&Mn.par[Ln].sid!=Jn||(-1<jn?this.par[jn].restore(Mn.par[Ln]):this.add(Mn.par[Ln],Cn)));null==Cn&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Mn){for(var Cn=0;Cn<this.par.length;Cn++)if(this.par[Cn].sameas(Mn.coords))return Cn;return-1},this.update=function(){mt.start('updatePinside');var Mn=renderblock;if(renderblock=1,ba(),params.showbergart)for(var Cn=0;Cn<this.par.length;Cn++)if(('L'==this.par[Cn].type||this.par[Cn].ispartofQ)&&(this.par[Cn].isarea&&Ye(this.par[Cn].coords,Ce(this.par[Cn].bergart),this.par[Cn].ispartofQ),''!=this.par[Cn].comment)){var Jn,Ln,Rn=this.par[Cn].coords.length;Jn=this.par[Cn].coords[Rn-2],Ln=this.par[Cn].coords[Rn-1];var jn=U('comment!',Jn,Ln,5,1);Fi.add(jn)}renderblock=Mn,mt.end('updatePinside')}}function Ne(Mn){var Cn=Mn.length;return Cn%2?(console.log('Odd amount of coordinates?'),console.log(Mn),!1):!(8>Cn)&&Mn[0]==Mn[Cn-2]&&Mn[1]==Mn[Cn-1]}function _e(Mn){var Cn=gl<yl,Rn=allq.get(Mn);return-1<Rn&&(Cn=allq.qar[Rn].ps>allq.qar[Rn].pe?0:Cn),gl<tunborder&&(Cn=13730<Mn&&13915>Mn||14350<Mn&&14980>Mn?0:1),17057<Mn&&17068>Mn&&(Cn=1),Cn}function We(){this.qar=[],this.add=function(Mn){var Cn=new Ue;Cn.restore(Mn),this.qar.push(Cn)},this.get=function(Mn){for(var Ln,Cn=1e3,Rn=-2,Jn=0;Jn<this.qar.length;Jn++)Ln=Cn,(this.qar[Jn].pe>Mn&&this.qar[Jn].ps<Mn||this.qar[Jn].ps>Mn&&this.qar[Jn].pe<Mn)&&(Cn=Math.min(Cn,Math.abs(Mn-this.qar[Jn].ps),Math.abs(Mn-this.qar[Jn].pe),Math.abs(Mn-(this.qar[Jn].pe+this.qar[Jn].ps)/2)),Ln!=Cn&&(Rn=Jn));return Rn},this.remove=function(Mn){-1<Mn&&(console.log('Removed Q'),oman.updchangelist(this.qar[Mn].sid),this.qar.splice(Mn,1))},this.removeP=function(Mn){var Cn=this.get(Mn);-1<Cn?this.qar.splice(Cn,1):console.log('No such Q with pel'+Mn)},this.getoverlaps=function(){for(var Mn=[],Cn=0;Cn<this.qar.length;Cn++){for(var Rn=0,Jn=this.qar[Cn],Ln=Math.min(Jn.ps,Jn.pe),jn=Math.max(Jn.ps,Jn.pe),Pn=Cn+1;Pn<this.qar.length;Pn++){var An=this.qar[Pn],En=Math.min(An.ps,An.pe),Tn=Math.max(An.ps,An.pe);if(En<=jn&&En>=Ln){if(En==jn)continue;var On=[En,Math.min(Tn,jn)];Mn.push(On),Jn.Q==An.Q&&Jn.comment==An.comment&&(Jn.sid>An.sid?(console.log('Removing overlap',An),this.remove(Pn),Pn--):Rn=1);continue}if(Tn<=jn&&Tn>=Ln){if(Tn==Ln)continue;var On=[Math.max(En,Ln),Tn];Mn.push(On),Jn.Q==An.Q&&Jn.comment==An.comment&&(Jn.sid>An.sid?(console.log('Removing overlap',An),this.remove(Pn),Pn--):Rn=1)}}Rn&&(console.log('Removing i',Jn),this.remove(Cn),Cn--)}return 2<Mn.length&&console.log('Overlaps',Mn),Mn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),va(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Mn=0;Mn<this.qar.length;Mn++)if(fa(this.qar[Mn].ps,this.qar[Mn].pe,this.qar[Mn].getQ(),this.qar[Mn].class,this.qar[Mn].comment),'none'!=this.qar[Mn].bergart){var Cn=new Ge,Rn=new Ie;Rn.ispartofQ=1;var Jn=Ca(this.qar[Mn].ps),Ln=Ca(this.qar[Mn].pe);Rn.coords=[-Mi,Jn,-Mi,Ln,Mi,Ln,Mi,Jn],Rn.bergart=this.qar[Mn].bergart,Rn.isarea=!0,Cn.add(Rn,1),allp.restore(Cn,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){va(),this.qar=[]},this.restore=function(Mn,Cn,Rn){var Jn=!1;null!=Rn&&(Jn=Rn);for(var Ln=0;Ln<Mn.qar.length;Ln++)if((null==Mn.qar[Ln].sid&&(Mn.qar[Ln].sid=Qn),null==Mn.qar[Ln].author&&(Mn.qar[Ln].author=Vn),!(1==Jn&&Mn.qar[Ln].sid<hl))&&!(1<Jn&&Mn.qar[Ln].sid!=Jn)){if(params.onlycurpel&&(!_a(Mn.qar[Ln].ps)||!_a(Mn.qar[Ln].pe))){console.log('Q not in limits'+Mn.qar[Ln].ps+' '+Mn.qar[Ln].pe);continue}var jn=this.isequal(Mn.qar[Ln]);-1<jn?this.qar[jn].restore(Mn.qar[Ln]):this.add(Mn.qar[Ln])}null==Cn&&this.update()},this.isequal=function(Mn){for(var Cn=0;Cn<this.qar.length;Cn++)if(this.qar[Cn].ps==Mn.ps&&this.qar[Cn].pe==Mn.pe)return Cn;return-1}}function Ue(){this.author=params.author,this.sid=hl,this.lastchange=hl,this.ps=gl,this.pe=yl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Mn){this.ps=Mn.ps,this.pe=Mn.pe,this.comment=Mn.comment,this.bergart=Mn.bergart,this.RQDc=Mn.RQDc,this.Jrc=Mn.Jrc,this.Jwc=Mn.Jwc,this.Jnc=Mn.Jnc,this.Jac=Mn.Jac,this.SRFc=Mn.SRFc,this.Jnmultc=1,this.RQD=Mn.RQD,this.Jr=Mn.Jr,this.Jw=Mn.Jw,this.Jn=Mn.Jn,this.Ja=Mn.Ja,this.SRF=Mn.SRF,null!=Mn.author&&(this.author=Mn.author),null!=Mn.sid&&(this.sid=Mn.sid),this.lastchange=null==Mn.lastchange?this.sid:Mn.lastchange,this.getQ()}}function Ye(Mn,Cn,Rn){for(var jn,Jn=[],Ln=0;Ln<Mn.length;Ln+=2)jn=new THREE.Vector3(Mn[Ln],Mn[Ln+1],1-0.02*Rn),Jn.push(jn);var An,En,Tn=new THREE.Geometry,On=new THREE.MeshBasicMaterial({color:Cn,transparent:!0,opacity:0.7});On.side=THREE.DoubleSide,Tn.vertices=Jn,An=THREE.ShapeUtils.triangulateShape(Jn,[]);for(var Ln=0;Ln<An.length;Ln++)Tn.faces.push(new THREE.Face3(An[Ln][0],An[Ln][1],An[Ln][2]));En=new THREE.Mesh(Tn,On),Fi.add(En),$()}function Ke(Mn){for(var Cn=Mn.elements,Rn=0;Rn<Cn.length;Rn++)Cn[Rn]=mr(Cn[Rn]);return Cn}function $e(Mn,Cn){var Rn={x:(Mn/Mi+1)/2,y:(Cn/Ci+1)/2};return Rn}function et(Mn,Cn){var Rn=Cn.x-Mn[0].x,Jn=Cn.y-Mn[0].y,Ln=0<(Mn[1].x-Mn[0].x)*Jn-(Mn[1].y-Mn[0].y)*Rn;return 0<(Mn[2].x-Mn[0].x)*Jn-(Mn[2].y-Mn[0].y)*Rn!=Ln&&0<(Mn[2].x-Mn[1].x)*(Cn.y-Mn[1].y)-(Mn[2].y-Mn[1].y)*(Cn.x-Mn[1].x)==Ln}function tt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Zi),cameraFix.position.set(0,0,Zi),Ta(),lt(),Sa()}function lt(){var Mn=window.devicePixelRatio;zl=el,Fl=il,camera.left=-Mi,camera.right=Mi,camera.top=Ci+Ri,camera.bottom=-Ci+Ri,cameraFix.left=-Mi,cameraFix.right=Mi,cameraFix.top=Ci+Ri,cameraFix.bottom=-Ci+Ri,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Mi-1.2,camera.right=Mi+1.2,zl*=1.3,lsc=0.5),zl/=Mn,Fl/=Mn;'For 3d'!=params.what2plot&&4096<Fl&&(zl=4096*zl/Fl,Fl=4096);var Rn=zl,Jn=Fl;'For 3d'==params.what2plot,renderer.setSize(Rn,Jn),Wi=new THREE.Vector2(Rn,Jn),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/Jn));var Ln=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Ln,16384/Ln,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function it(){Sl||(sensivity=1,D(),params.what2plot='For 3d',St(gl,yl,1),tt(),ka(),Sl=!0,renderer.render(Vl,cameraFix,buftext),ut(),Lt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,$(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),wa('3d'))}function rt(){if(Sl){for(sensivity=5,D();0<pi.children.length;)pi.remove(pi.children[0]);buftext.dispose(),Vl=ui,params.resetcam(),controls.enableRotate=!1,Sl=!1,camera.position.set(0,0,Zi),lsc=1,ut(),Sa(),ka(),St(gl,yl),setTimeout(function(){$()},50),Ii.value='Select',wa('Line'),check3dbox.style.display='none'}}function dt(){yl+=5*pmult,gl-=5*pmult,fl=Math.abs(parseInt(gl)-parseInt(yl)),il=vl*fl,Fl=il,Ci=il/Vi,P(gl,yl,Ri),St(gl,yl),fa(gl,yl,-1),pt(sl,Ca(yl-2.5*pmult)),pt(sl,Ca(gl+2.5*pmult)),$()}function pt(Mn,Cn){var Rn=new THREE.MeshBasicMaterial({color:16777215}),Jn=new THREE.PlaneGeometry(5*(2*(vl/Vi)),2*Mi,1,1),Ln=new THREE.Mesh(Jn,Rn);Ln.position.set(0,Cn,0),Ln.rotateZ(Math.PI/2),Nl.push(Ln),mi.add(Ln)}function ut(){z(),Wi=new THREE.Vector2(Ni,_i),Xi=Ni/_i,camera.left=-Yi*Xi/2,camera.right=Yi*Xi/2,camera.top=Ki/2,camera.bottom=-Ki/2,camera.updateProjectionMatrix(),renderer.setSize(Ni,_i),$()}function gt(){if(Ds)return!1;for(var Mn=0,Cn=0;Cn<_l.length;Cn++)1!=_l[0].skip&&(Mn=1);if(allq.qar.length&&(Mn=1),!Mn)return!1;var Rn=new Date().getTime(),Jn=Pa(1),Ln=JSON.stringify(Jn);localStorage.setItem(Ul.s,Ln);var jn=new Date().getTime()-Rn;return console.log('dT = '+jn),!0}function yt(){if(localStorage.getItem(Ul.l)){var Mn=localStorage.getItem(Ul.l),Cn=JSON.parse(Mn);console.log('Sid set to',Cn.sid),Da(Cn),allq.update(),Sa(),$(),params.restses=0,wa('Line')}}function vt(Mn,Cn){var Rn=new FormData;Rn.append('data',Mn),Rn.append('fname',Cn);try{var Jn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Jn.open('post',baseaddr+'procfile.php',!0),Jn.send(Rn)}catch(Ln){console.log(Ln)}}function bt(){var Mn=new FormData;Mn.append('data',params.author);try{var Cn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Cn.onreadystatechange=function(){if(4===Cn.readyState){var Rn=JSON.parse(Cn.response);filetable(container,Rn,function(Jn){var Ln=pelfromfname(Jn),jn=Ln[0],Pn=Ln[1];saveifokdist(jn,Pn),xt(Jn)})}},Cn.open('post',baseaddr+'getflist.php',!0),Cn.send(Mn)}catch(Rn){console.log(Rn)}}function xt(Mn){var Cn=new FormData;Cn.append('fname',Mn);try{var Rn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Rn.onreadystatechange=function(){if(4===Rn.readyState){if(params.overridepel){var Jn=pelfromfname(Mn),Ln=getpelrange(Rn.response,Jn[0],Jn[1]);Dn=[],sl='',ua(Ln[0],Ln[1])}Da(Rn.response),allq.update(),Sa(),$()}},Rn.open('post',baseaddr+'gettxt.php',!0),Rn.send(Cn)}catch(Jn){console.log(Jn)}}function wt(Mn){var Cn=basekjor;'Kjorholt'==Mn&&(Cn=basekjor),'Bamle'==Mn&&(Cn=basebamble);var Rn=Mn+picparams.ps+'_'+picparams.pe+'.xml',Jn=Cn+La(Mn)+endfile,Ln=vkbeautify.xml(Jn);download(Ln,Rn)}function St(Mn,Cn,Rn){if(Vl.remove(xi),!!params.rutenett){xi=new THREE.Object3D;var Jn=normPel(Mn,Cn),Ln=Jn[0],jn=Jn[1],Pn=-4;null!=Rn&&(Pn=-0.5);for(var In,Bn=Ln;Bn<=jn;Bn++){In=[],In.push(-Mi,Ca(Bn),1,1.13*Mi,Ca(Bn),1);var Gn=I(In,Pn,'0#000000');xi.add(Gn)}Vl.add(xi)}}function zt(){if(params.vederlag){var Mn=tungeom[params.tunnel].Width,Cn=[];for(var Rn in Mn){var Jn=Mn[Rn][1],Ln=Mn[Rn][3],jn=Mn[Rn][5],Pn=jn-Jn;Cn.push([Mn[Rn][0],2*((Mn[Rn][2]-Jn)/Pn)-1,2*((Mn[Rn][3]-Jn)/Pn)-1,2*((Mn[Rn][4]-Jn)/Pn)-1])}for(var Gn,Nn,_n,Wn,Pn,An=normPel(gl,yl),En=An[0],Tn=An[1],On=[],Bn=[],In=[],Un=1,Rn=En;Rn<Tn;Rn++){if(Pn=Math.max(Rn,Cn[0][0]),Pn=Rn,Gn=Ft(Pn,Cn),_n=Ca(Pn),Nn=Ft(Pn+pmult,Cn),Wn=Ca(Pn+1),!Gn||!Nn){console.log('No vederlag data for pel=',Rn),Un=0;break}On.push(Gn[0]),On.push(_n),On.push(1),Bn.push(Gn[1]),Bn.push(_n),Bn.push(1),In.push(Gn[2]),In.push(_n),In.push(1)}Un&&(On.push(Nn[0]),On.push(Wn),On.push(1),Bn.push(Nn[1]),Bn.push(Wn),Bn.push(1),In.push(Nn[2]),In.push(Wn),In.push(1)),I(On,-4,'0#000000'),I(Bn,-4,'0#000000'),I(In,-4,'0#000000'),$()}}function Ft(Mn,Cn){for(var Rn=Cn.length,Jn=xct=xrt=0,Ln=0,jn=0,Pn=0;Pn<Rn-1;Pn++)if(Mn>=Cn[Pn][0]&&Mn<Cn[Pn+1][0]||Mn<=Cn[Pn][0]&&Mn>Cn[Pn+1][0]){var An=Cn[Pn+1][0]-Cn[Pn][0];0==An?Ln=[Cn[Pn][1]*Mi,Cn[Pn][2]*Mi,Cn[Pn][3]*Mi]:(jn=(Mn-Cn[Pn][0])/(Cn[Pn+1][0]-Cn[Pn][0]),Jn=Cn[Pn][1]+jn*(Cn[Pn+1][1]-Cn[Pn][1]),xct=Cn[Pn][2]+jn*(Cn[Pn+1][2]-Cn[Pn][2]),xrt=Cn[Pn][3]+jn*(Cn[Pn+1][3]-Cn[Pn][3]),Ln=[Jn*Mi,xct*Mi,xrt*Mi])}return Ln?Ln:Mn<Cn[0][0]?[Cn[0][1]*Mi,Cn[0][2]*Mi,Cn[0][3]*Mi]:[Cn[Rn-1][1]*Mi,Cn[Rn-1][2]*Mi,Cn[Rn-1][3]*Mi]}function Dt(Mn,Cn){var Rn=Mn;return 7==Rn.length?(Rn=null==Cn?'0x'+Rn[5]+Rn[6]+Rn[3]+Rn[4]+Rn[1]+Rn[2]:'0x'+Rn[1]+Rn[2]+Rn[3]+Rn[4]+Rn[5]+Rn[6],parseInt(Rn)):0}function Qt(){Sl?(Ei.style.display='none',Ti.style.display='none',Oi.style.display='none',Ii.style.display='none',Gi.style.display='none'):(Ei.style.display='',Ti.style.display='',Oi.style.display='',Ii.style.display='',Gi.style.display='')}function Vt(){Ei.setAttribute('class','geobutton'),Ti.setAttribute('class','geobutton'),Oi.setAttribute('class','geobutton'),Bi.setAttribute('class','geobutton'),Ii.setAttribute('class','geobutton')}function Ct(Mn){var Cn=[],Rn=Mn.length;for(var Jn in Cn.push(Ot(Mn[0][0]+1,Mn)),Mn)Mn[Jn][0]>Mn[0][0]+1&&Mn[Jn][0]<Mn[Rn-1][0]-1&&Cn.push(Ot(Mn[Jn][0],Mn));return Cn.push(Ot(Mn[Rn-1][0]-1,Mn)),Cn}function Rt(Mn){var Cn=tungeom[Mn].TunProfile,Rn=parse3dmod(Cn),Jn=Ct(Rn),Ln=Pt(Rn);for(var jn in Jn)Ln.add(Jt(Jn[jn]));var Pn=(Rn[0][0]+Rn[Rn.length-1][0])/2,An=-Ca(Pn);return[Rn,Ln]}function Jt(Mn){var Cn=[];for(var Rn in Mn.v)Cn.push(Mn.v[Rn].x),Cn.push(Mn.v[Rn].y),Cn.push(Mn.v[Rn].z);var Jn=new THREE.Object3D,Ln=I(Cn,10,'0#000000');return Jn.add(Ln),Jn}function Lt(){p2y=Ca;var Mn=Sn,Cn=Mn[0];lingeom=new THREE.Object3D,lingeom.add(Sn[1]),lingeom.add(Fn);var Rn=(Cn[0][0]+Cn[Cn.length-1][0])/2,Jn=Ca(Rn),Ln=getglobc((gl+yl)/2);lingeom.position.set(-Ln.x,-Ln.y,-Ln.z);var jn=Tt(Cn),Pn=jn[0];for(var An in partlingeom=jn[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!1}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,Pn){var En=new THREE.Mesh(Pn[An][2],pmat);En.castShadow=!1,En.receiveShadow=!1,meshes.add(En)}meshes.position.set(-Ln.x,-Ln.y,-Ln.z),my3dgroup.add(meshes),pi=new THREE.Scene,ui=Vl;var Ln=getglobc((gl+yl)/2),Tn=new THREE.Object3D;''!=strin&&Tn.add(Dl),Tn.position.set(-Ln.x,-Ln.y,-Ln.z),my3dgroup.add(Tn),Pn[0][2].computeBoundingSphere();var On=Pn[0][2].boundingSphere.center,Bn=new THREE.Quaternion;Bn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(Bn);for(var In,Gn,Nn=0;Nn<oman.ao.length;Nn++)if('B'==oman.ao[Nn].type){var _n=$e(oman.get(Nn).xs,oman.get(Nn).ys),Wn=Ra(oman.get(Nn).ys),Un=new THREE.Vector2(_n.x,_n.y);for(var Hn in Pn)if(numintersect(Pn[Hn][0],Pn[Hn][1],Wn,Wn)){In=wn(meshes.children[Hn],Un);break}var Xn=$e(oman.get(Nn).xe,oman.get(Nn).ye),Wn=Ra(oman.get(Nn).ye),Un=new THREE.Vector2(Xn.x,Xn.y);for(var Hn in Pn)if(numintersect(Pn[Hn][0],Pn[Hn][1],Wn,Wn)){Gn=wn(meshes.children[Hn],Un);break}var Yn=Gn[0],Kn=Gn[1],Zn=In[0],$n=In[1],eo=10,to=xn(new THREE.Vector3(Zn.x,Zn.y,Zn.z),new THREE.Vector3(Yn.x+1*($n.x*eo),Yn.y+1*($n.y*eo),Yn.z+1*($n.z*eo)));Tn.add(to)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),pi.add(my3dgroup),pi.add(fallar),pi.add(line3dgroup),pi.add(line3dtemp),controls.enableRotate=!0,$()}function Pt(Mn){for(var Cn=Mn[0][1].length,Rn=new THREE.Object3D,Jn=[],Ln=Mn[0][1],jn=[],Pn=Mn[0][0]+1;Pn<Mn[Mn.length-1][0]-1;Pn+=2)jn.push(Ot(Pn,Mn));for(var An in Ln){for(var En in Jn=[],jn){var Tn=jn[En],On=Tn.v[An];Jn.push(On.x,On.y,On.z)}var An=I(Jn,5,'0#000000');Rn.add(An)}return Rn}function Et(Mn,Cn){var Rn=[];if(Mn<Cn[0][0])return Dl=[Mn,Cn[0][1]],console.log('Not inside pel limits'),console.log(Mn,Cn[0][0]),Dl;if(Mn>Cn[Cn.length-1][0])return Dl=[Mn,Cn[Cn.length-1][1]],console.log('Not inside pel limits'),console.log(Mn,Cn[Cn.length-1][0]),Dl;for(var Jn=1;Jn<Cn.length;Jn++)if(Mn>=Cn[Jn-1][0]&&Mn<=Cn[Jn][0]){var Ln=Cn[Jn-1][0],jn=Cn[Jn][0],Pn=(Mn-Ln)/(jn-Ln);for(var An in Cn[Jn][1]){var En=Cn[Jn][1][An],Tn=Cn[Jn-1][1][An];Rn.push(new THREE.Vector2(En.x*Pn+Tn.x*(1-Pn),En.y*Pn+Tn.y*(1-Pn)))}break}return Rn.length||console.log('Error! Vout not defined in getcurveatpel'),[Mn,Rn]}function Tt(Mn){for(var Tn,Cn=gl,Rn=yl,Jn=Et(Cn,Mn),Ln=Et(Rn,Mn),jn=-1,Pn=[[0,Jn]],An=[],En=0;En<Mn.length;En++)if((Tn=Mn[En][0],Math.round(jn)!=Math.round(Tn))&&(jn=Tn,Tn=Math.round(Tn),Wa(Tn,Cn,Rn))){var On=(Tn-Cn)/(Rn-Cn);An.push([On,Mn[En]])}if(0<pmult)for(var Bn=0;Bn<An.length;Bn++)Pn.push(An[Bn]);else for(var Bn=An.length-1;-1<Bn;Bn--)Pn.push(An[Bn]);Pn.push([1,Ln]);for(var In=new THREE.Object3D,Gn=[],Nn=[],Bn=0;Bn<Pn.length-1;Bn++)for(var _n=Pn[Bn][1][0],Wn=Pn[Bn+1][1][0],Un=0,En=_n;0>(En-Wn)*pmult;En+=5*pmult){Un++;var On=(En-Cn)/(Rn-Cn);if(Nn.push([On,Et(En,Mn)]),500<Un)return}Nn.push(Pn[Pn.length-1]);for(var Bn=1;Bn<Nn.length;Bn++){var Hn=Ot(Nn[Bn][1][0],Mn),Xn=Ot(Nn[Bn-1][1][0],Mn);Gn.push([Nn[Bn-1][1][0],Nn[Bn][1][0],Bt(Xn,Hn,Nn[Bn-1][0],Nn[Bn][0])])}return[Gn,In]}function Ot(Mn,Cn){var Rn=Et(Mn,Cn),Jn=getglobc(Mn),Ln=getglobc(Mn,1)[1]/180*Math.PI,jn=getglobc(Mn+0.01),Pn=new THREE.Quaternion;null==jn?(jn=getglobc(Mn).sub(getglobc(Mn-0.01)).normalize(),jn=jn.normalize(),jn.z=0,Pn.setFromUnitVectors(new THREE.Vector3(1,0,0),jn)):(jn=getglobc(Mn+0.01).sub(Jn),jn=jn.normalize(),jn.z=0,Pn.setFromUnitVectors(new THREE.Vector3(1,0,0),jn)),0.1<Math.abs(Pn.y)&&(console.log(Mn,Jn,jn),console.log(Mn,Pn));var An={pel:Mn,v:[]};for(var En in Rn[1]){var Tn=Rn[1][En],On=Math.sin(Ln),Bn=Math.cos(Ln),In=new THREE.Vector3(0,Tn.x,Tn.y);In.applyAxisAngle(new THREE.Vector3(1,0,0),Ln),In.applyQuaternion(Pn),In.add(Jn),An.v.push(In)}return An}function Bt(Mn,Cn,Rn,Jn){var Ln=new THREE.Geometry,jn=0,Pn=Mn.v.length;Ln.faceVertexUvs[0]=[];for(var An=0;An<Pn-1;++An){var En=Mn.v[An],Tn=Mn.v[An+1],On=Cn.v[An],Bn=Cn.v[An+1],In=(Pn-(An+1))/(Pn-1),Gn=(Pn-(An+2))/(Pn-1),Nn=null==Rn?0:Rn,_n=null==Jn?1:Jn;Ln.vertices.push(new THREE.Vector3(En.x,En.y,En.z)),Ln.vertices.push(new THREE.Vector3(Tn.x,Tn.y,Tn.z)),Ln.vertices.push(new THREE.Vector3(On.x,On.y,On.z)),Ln.vertices.push(new THREE.Vector3(Bn.x,Bn.y,Bn.z)),Ln.faces.push(new THREE.Face3(jn+2,jn+1,jn)),Ln.faces.push(new THREE.Face3(jn+1,jn+2,jn+3)),Ln.faceVertexUvs[0].push([new THREE.Vector2(In,_n),new THREE.Vector2(Gn,Nn),new THREE.Vector2(In,Nn)]),Ln.faceVertexUvs[0].push([new THREE.Vector2(Gn,Nn),new THREE.Vector2(In,_n),new THREE.Vector2(Gn,_n)]),jn+=4}return Ln.uvsNeedUpdate=!0,Ln.computeFaceNormals(),Ln}function It(){Fn=new THREE.Object3D;var Mn=tun2='';if('34100'==params.tunnel&&(tun2='34100',Mn='34000'),'34000'==params.tunnel&&(tun2='34000',Mn='34100'),Mn){globavg=tungeom[Mn].Geo3d.globavg,globtc=tungeom[Mn].Geo3d.globtc,Fn=Rt(Mn)[1];var Cn=tv().copy(tungeom[Mn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Fn.position.set(Cn.x,Cn.y,Cn.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,'Kjorholt'==params.tunnel&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,Sn=Rt(params.tunnel),''!=strin&&(Dl=makecloud(strin))}function Gt(){var Mn=linez.length;if(!(2>Mn)){for(var Rn,Cn=1;Cn<Mn;Cn++)Rn=new Ma,Rn.addline(linez[Cn-1].xs,linez[Cn-1].ys,1,linez[Cn].xs,linez[Cn].ys,1,Math.round(30*params.size),'#000000'),oman.add(Rn);var Jn=linez[0].v,Ln=linez[Math.floor(Mn/2)].v,jn=linez[Mn-1].v,Pn=Nt();return console.log(Pn),console.log('Prev'),console.log([Jn,Ln,jn]),Pn}}function Nt(){for(var Mn=linez.length,Cn=Math.floor(Mn/3),Rn=Math.floor(2*Mn/3),Jn=tv(),Ln=tv(),jn=tv(),Pn=0;Pn<Cn;Pn++)Jn.add(linez[Pn].v);Jn.multiplyScalar(1/Cn);for(var Pn=Cn;Pn<Rn;Pn++)Ln.add(linez[Pn].v);Ln.multiplyScalar(1/(Rn-Cn));for(var Pn=Rn;Pn<Mn;Pn++)jn.add(linez[Pn].v);return jn.multiplyScalar(1/(Mn-Rn)),[Jn,Ln,jn]}function Ut(Mn){var Cn=new THREE.Plane().setFromCoplanarPoints(Mn[0],Mn[1],Mn[2]),Rn=new THREE.Vector3((Mn[0].x+Mn[1].x+Mn[2].x)/3,(Mn[0].y+Mn[1].y+Mn[2].y)/3,(Mn[0].z+Mn[1].z+Mn[2].z)/3),Jn=new THREE.BoxGeometry(150,150,0.5),Ln=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),jn=new THREE.Mesh(Jn,Ln),Pn=new THREE.Quaternion;Pn.setFromUnitVectors(new THREE.Vector3(0,0,1),Cn.normal),jn.applyQuaternion(Pn),jn.position.set(Rn.x,Rn.y,Rn.z),jn.scale.set(fscale.val,fscale.val,1),fallar.add(jn)}function Ht(Mn){var Cn=new THREE.Plane().setFromCoplanarPoints(Mn[0],Mn[1],Mn[2]),Rn=new THREE.Vector3((Mn[0].x+Mn[1].x+Mn[2].x)/3,(Mn[0].y+Mn[1].y+Mn[2].y)/3,(Mn[0].z+Mn[1].z+Mn[2].z)/3),Jn=Cn.normal;0>Jn.y&&Jn.negate();var Ln=180*new THREE.Vector3(0,1,0).angleTo(Jn)/Math.PI,jn=Ra(linez[0].ys),Pn=getglobc(jn+1).sub(getglobc(jn));Pn=Pn.normalize();var An=getglobc((gl+yl)/2),En=new THREE.Quaternion;En.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),Pn.applyQuaternion(En);var Tn=new THREE.Quaternion;Tn.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(En),new THREE.Vector3(1,0,0).applyQuaternion(En));var On=tv().copy(Pn).applyQuaternion(Tn),Bn=new THREE.Plane().setFromCoplanarPoints(Rn,tv().copy(Rn).add(On),tv().copy(Rn).add(Pn)),In=tv().copy(Jn).projectOnPlane(Bn.normal),Gn=In.angleTo(Pn)<Math.PI/2?1:0,Nn=180*In.angleTo(On)/Math.PI;return Nn=Gn?360-Nn:Nn,console.log('Strike:',Nn),console.log('Dip/Fall',Ln),[Math.floor(Nn),Math.round(Ln)]}function Kt(){if(linez.length){var Mn=new ConvexHullGrahamScan;for(var Cn in linez)Mn.addPoint(linez[Cn].xs,linez[Cn].ys);var Rn=Mn.getHull(),Jn=[];for(var Ln in linez)for(var Cn in Rn){var jn=linez[Ln];Rn[Cn].x==jn.xs&&Rn[Cn].y==jn.ys&&Jn.push(jn)}linez=Jn,linez.sort(function(On,Bn){return Bn.xs-On.xs});var Pn=y=0;for(var Ln in linez)Pn+=linez[Ln].xs,y+=linez[Ln].ys;Pn/=linez.length,y/=linez.length;var An=Gt(),En=Ht(An),Tn=new Ma;Tn.addfall(Pn,y,8,En[0],En[1],1),Tn.color=An,oman.plot(Tn),oman.add(Tn),Zt(linez),Sa(),$(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,ns.updateDisplay()}}function Zt(Mn){var Cn=[];for(var Rn in Mn)Cn.push(Mn[Rn].v.x,Mn[Rn].v.y,Mn[Rn].v.z);if(Cn.length){var Jn=I(Cn,Math.round(40*params.size),'#000000',1);line3dgroup.add(Jn)}}function $t(Mn){var Cn=new Date().getTime();if(5e3<Cn-si){for(var Rn in Ql){var Jn=Ql[Rn];Jn.redrawInterval=1}for(var Rn in $(Mn),Ql){var Jn=Ql[Rn];Jn.redrawInterval=1e5}si=Cn}else $(Mn)}function pa(){params.withbg?ca(sl):ca(''),as.material=ls,$()}function ca(Mn){if(''==Mn)ls=new THREE.MeshBasicMaterial({color:16777215});else{var Cn=new THREE.TextureLoader;Cn.crossOrigin='anonymous';var Rn=Cn.load(Mn,function(){$()});Rn.magFilter=THREE.NearestFilter,Rn.minFilter=THREE.LinearMipMapLinearFilter,Rn.anisotropy=2,gl>yl&&(Rn.flipY=!1),ls=new THREE.MeshBasicMaterial({map:Rn})}}function ua(Mn,Cn){hl=getsessionid(),V(),yl=parseInt(Cn),gl=parseInt(Mn),pmult=gl<yl?1:-1,wl=(gl+yl)/2,fl=Math.abs(parseInt(gl)-parseInt(yl)),vl=50,11>fl&&(vl=100),6>fl&&(vl=200),il=vl*fl,Fl=il,Ci=il/Vi,P(gl,yl,Ri),St(gl,yl),ya(sl,0),fa(gl,yl,-1),params.resetcam(),$(),picparams.ps=gl,picparams.pe=yl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function ha(Mn,Cn,Rn){console.log('in pelfrom pic',picparams.ps,picparams.pe);var Jn=params.tunnel;null!=Rn&&(Jn=Rn);var Ln=Mn>Cn,jn=Math.min(Mn,Cn),Pn=Math.max(Mn,Cn),An=25*Math.floor(jn/25);if(0>An||0>En)return void console.log('Trying to get negative pels',An,En);var En=25*Math.floor((Pn-0.01)/25+1);console.log('Before count',An,En);var Tn=gettunlim(Jn);console.log('Tunlims',Tn),'Kjorholt'==params.tunnel&&(Tn.pmin=13650);var On=checklims(An,En,Tn);An=On[0],En=On[1];for(var Bn=An;Bn<En;Bn+=25){var In=Math.round(Math.min(parseInt(Bn+25),En)),Gn=Jn+Bn+'_'+In;console.log('Searching in db:',Gn),dbgetpic(Gn,function(Nn){-1!=Nn&&ga(Nn,Ln)})}sl='',Ln?ua(En,An):ua(An,En),rt()}function ga(Mn,Cn){var Rn=gl>yl;null!=Cn&&(Rn=Cn);var Jn=new THREE.TextureLoader;Jn.crossOrigin='anonymous',null!=Mn.tunmodel&&(deftm=Mn.tunmodel);var Ln=Jn.load(Mn.pic,function(){$()});Ln.magFilter=THREE.NearestFilter,Ln.minFilter=THREE.LinearMipMapLinearFilter,Ln.anisotropy=2,Rn&&(Ln.flipY=!1);var jn=new THREE.MeshBasicMaterial({map:Ln}),Pn=Math.abs(Ca(Math.max(Mn.ps,Mn.pe))-Ca(Math.min(Mn.ps,Mn.pe))),An=Ca((Mn.ps- -Mn.pe)/2),En=new THREE.PlaneGeometry(Pn,2*Mi,1,1);as=new THREE.Mesh(En,jn),as.position.set(0,An,0.01);var Tn=Rn?Math.PI:0;as.rotateZ(Math.PI/2+Tn),Nl.push(as),mi.add(as)}function ya(Mn,Cn){Vl.remove(mi),mi=new THREE.Object3D,Nl.length=0,ca(Mn);var Rn=new THREE.PlaneGeometry(2*Ci,2*Mi,1,1);as=new THREE.Mesh(Rn,ls),as.position.set(0,Cn/vl,0);var Jn=gl>yl?Math.PI:0;as.rotateZ(Math.PI/2+Jn),Nl.push(as),mi.add(as),Vl.add(mi)}function fa(Mn,Cn,Rn,Jn,Ln){var jn,Pn=!1;-1==Rn?(Pn=!0,jn=11184810):(jn=16711680,1<Rn&&(jn=16769024),4<Rn&&(jn=16746240),10<Rn&&(jn=2258722));var An=Pn?1:0.8,En=new THREE.MeshBasicMaterial({color:jn,transparent:!0,opacity:An}),Tn=Ca((Mn+Cn)/2),On=Math.abs(Ca(Cn)-Ca(Mn)),Bn=Mi/3,In=-Mi-Bn+Mi/10,Gn=new THREE.PlaneGeometry(Bn,On,1,1),Nn=new THREE.Mesh(Gn,En);if(Nn.position.set(In,Tn,Pn?0:1),Pn){var _n=zi.children[0];null!=_n&&zi.remove(_n),zi.add(Nn),Nl.push(Nn)}else{Si.add(Nn);var Wn=U('Q='+Rn+' '+Jn,In,Tn,10,0);if(Si.add(Wn),null!=Ln&&''!=Ln){for(var Un='',Hn=0;Hn<Math.min(4,Ln.length);Hn++)Un+=Ln[Hn];Un+='..!';var Xn=U(Un,In-0.35*Ji,Tn+0.38*On,10,1);Si.add(Xn)}}}function va(){for(;Si.children.length;){var Mn=Si.children[0];'undefined'!=typeof Mn.material&&Mn.material.dispose(),'undefined'!=typeof Mn.geometry&&Mn.geometry.dispose(),Si.remove(Mn)}}function ba(){for(;Fi.children.length;){var Mn=Fi.children[0];'undefined'!=typeof Mn.material&&Mn.material.dispose(),'undefined'!=typeof Mn.geometry&&Mn.geometry.dispose(),Fi.remove(Mn)}}function xa(){for(;fi.children.length;){var Mn=fi.children[0];'undefined'!=typeof Mn.material&&Mn.material.dispose(),'undefined'!=typeof Mn.geometry&&Mn.geometry.dispose(),fi.remove(Mn)}for(;ki.children.length;){var Mn=ki.children[0];'undefined'!=typeof Mn.material&&Mn.material.dispose(),'undefined'!=typeof Mn.geometry&&Mn.geometry.dispose(),ki.remove(Mn)}for(;yi.children.length;){var Mn=yi.children[0];'undefined'!=typeof Mn.material&&Mn.material.dispose(),'undefined'!=typeof Mn.geometry&&Mn.geometry.dispose(),yi.remove(Mn)}}function wa(Mn,Cn){Wl=Mn;var Rn=Mn;Sl&&(Rn='3d'),Qt(),null==Rn&&(El=[],chosenp=-2);var Jn=ns.closed;return ns.destroy(),container.removeChild(ns.domElement),ns=new dat.GUI({autoPlace:!1,width:Math.min(400,Ni/2-4)}),container.appendChild(ns.domElement),ns.domElement.id='guipos','3d'==Rn?(ns.add(lingeom,'visible').name('Tunnel frame').onChange(function(){$()}),''!=strin&&(ns.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,$()}),ns.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,$()}),ns.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){$()}),ns.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,$()})),ns.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var Ln in fallar.children)fallar.children[Ln].scale.set(fscale.val,fscale.val,1);$()}),void ns.updateDisplay()):void(Me(Rn,Cn),null==Cn&&Ta(),Vt(),'Q - value'==Rn&&(ns.updateDisplay(),params.linetype='Q - value',Ii.value='Select'),'Line'==Rn&&(Ei.setAttribute('class','geobuttonf'),params.linetype='Line',q22=ks.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&ks.add(params,'size',0.1,1).name('Size').step(0.1),ks.add(params,'dummy').name('')),'Water'==Rn&&(Ti.setAttribute('class','geobuttonf'),params.linetype='Water',ks.add(params,'wsize',0.1,1).step(0.1).name('Size'),ks.add(params,'dummy').name('')),'Text'==Rn&&(Oi.setAttribute('class','geobuttonf'),params.linetype='Text',ks.add(params,'text').name(qa.ttp),ks.add(params,'dummy').name('')),'Fall'==Rn&&(Bi.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=ks.add(params,'angle',0,360).step(1).name(qa.angle),ks.add(params,'fall',0,90).step(1).name(qa.fall),ks.add(params,'dummy').name('')),'Bolt'==Rn&&(params.linetype='Bolt',ks.add(params,'boltlen',1,10).step(0.5).name(qa.len),ks.add(params,'bolttype',qa.boltlist).name(qa.material),ks.add(params,'dummy').name('')),'Select'==Rn?(Ii.setAttribute('class','geobuttonf'),params.linetype='Select'):ks.open(),ns.updateDisplay(),Jn?Ee():Ae())}function ka(){for(var Mn in vi.children.length=0,oman.ao){var Cn=oman.ao[Mn];Cn.toskip||'B'!=Cn.type||oman.plot(Cn)}}function Sa(){xa(),zt();for(var Mn=[],Cn=0;Cn<_l.length;Cn++)0==_l[Cn].skip&&Mn.push(_l[Cn]);for(var Ln,jn,Rn=yprev=cprev=sprev=-1e3,Jn=[],Cn=0;Cn<Mn.length;Cn++)if('L'==Mn[Cn].type)if(Rn==Mn[Cn].xs&&yprev==Mn[Cn].ys&&cprev==Mn[Cn].color&&sprev==Mn[Cn].size){var Pn=[Mn[Cn].xe,Mn[Cn].ye,Mn[Cn].zs];Rn=Mn[Cn].xe,yprev=Mn[Cn].ye,Jn.push(Pn[0]),Jn.push(Pn[1]),Jn.push(Pn[2])}else I(Jn,jn,Ln),Rn=Mn[Cn].xe,yprev=Mn[Cn].ye,cprev=Mn[Cn].color,sprev=Mn[Cn].size,Jn=[Mn[Cn].xs,Mn[Cn].ys,Mn[Cn].zs,Rn,yprev,Mn[Cn].zs],Ln=Mn[Cn].color,jn=Mn[Cn].size;I(Jn,jn,Ln)}function za(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Mn){var Rn=Ca(Mn);return Rn=mr(Rn),Rn},this.getnewx=function(Mn){var Cn=Mn/this.oldpw*Mi;return Cn=mr(Cn),Cn}}function Fa(Mn,Cn){for(var Rn in Cn)for(var Jn=Cn[Rn],Ln=0;Ln<Jn.length;Ln++)if(Jn[Ln]==Mn)return''+Rn;return null}function Da(Mn){mt.start('Get json');var Cn='object'==typeof Mn?JSON.parse(JSON.stringify(Mn)):JSON.parse(Mn);var Rn=Cn.objdata;mt.end('Get json');var Jn=new za,Ln=Cn.authors,jn=Cn.sids,Pn=Cn.chlist;if(null==Pn||isEmpty(Pn))for(var An in jn)oman.changelist[An]=An;else for(var An in jn)oman.changelist[An]=Pn[An];Jn.oldzero=Cn.zeropel,Vn=Cn.author,Jn.oldppu=Cn.pelperunit,Jn.oldpw=Cn.pw,Qn=Cn.sid,allq.restore(Cn.qval,1);for(var En=Cn.pval,Tn=0;Tn<En.par.length;Tn++)for(var An=0;An<En.par[Tn].coords.length;An+=2)En.par[Tn].coords[An]=Jn.getnewx(En.par[Tn].coords[An]),En.par[Tn].coords[An+1]=Jn.getnewy(En.par[Tn].coords[An+1],1);allp.restore(En,1);for(var Nn,On=Rn.length,Bn=6,In='#000000',Gn=qy=qz=tmpy=tmpx=-1e3,An=0;An<On;An++){if(Nn=new Ma,null==jn)Nn.sid=Qn;else{var _n=Fa(An,jn);Nn.sid=null==_n?Qn:_n}if(null==Ln)Nn.author=Vn;else{var _n=Fa(An,Ln);Nn.author=null==_n?Vn:_n}var Wn=Rn[An];if(2==Wn.length){tmpx=Jn.getnewx(Wn[0]/qprec),tmpy=Jn.getnewy(Wn[1]/qprec),Nn.addline(Gn,qy,qz,tmpx,tmpy,qz,Bn,In),Gn=Jn.getnewx(Wn[0]/qprec),qy=Jn.getnewy(Wn[1]/qprec),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn);continue}if(0==Wn[0]){Bn=15,In='#000000',6<Wn.length&&('number'==typeof Wn[6]&&(Bn=Wn[6]),'string'==typeof Wn[6]&&(In=Wn[6])),8==Wn.length&&(In=Wn[7]),Gn=Jn.getnewx(Wn[4]/qprec),qy=Jn.getnewy(Wn[5]/qprec),qz=Wn[3],tmpx=Jn.getnewx(Wn[1]/qprec),tmpy=Jn.getnewy(Wn[2]/qprec),Nn.addline(tmpx,tmpy,qz,Gn,qy,qz,Bn,In),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn);continue}if(1==Wn[0]){Bn=0.5,3<Bn.length&&(Bn=Wn[3]),tmpx=Jn.getnewx(Wn[1]/qprec),tmpy=Jn.getnewy(Wn[2]/qprec),Nn.addwater(tmpx,tmpy,10,Bn),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn);continue}if(2==Wn[0]){tmpx=Jn.getnewx(Wn[1]/qprec),tmpy=Jn.getnewy(Wn[2]/qprec);var Un=Wn[4];'_pho_'==Un.slice(0,5)&&(Nn.fall=1,Un=Un.slice(5),console.log(Un)),'_lab_'==Un.slice(0,5)&&(Nn.fall=2,Un=Un.slice(5)),Nn.addtext(Un,tmpx,tmpy,Wn[3],1),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn);continue}if(3==Wn[0]&&(tmpx=Jn.getnewx(Wn[1]/qprec),tmpy=Jn.getnewy(Wn[2]/qprec),Nn.addfall(tmpx,tmpy,10,Wn[3],Wn[4],Wn[5]),null!=Wn[6]&&(Nn.color=[tv(Wn[6][0].x,Wn[6][0].y,Wn[6][0].z),tv(Wn[6][1].x,Wn[6][1].y,Wn[6][1].z),tv(Wn[6][2].x,Wn[6][2].y,Wn[6][2].z)]),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn)),4==Wn[0]){Nn.addbolt(Jn.getnewx(Wn[1]/qprec),Jn.getnewy(Wn[2]/qprec),Wn[3],Jn.getnewx(Wn[4]/qprec),Jn.getnewy(Wn[5]/qprec),Wn[6],Wn[7]),oman.isdublicate(Nn),oman.plot(Nn),oman.add(Nn);continue}}}function Qa(Mn,Cn,Rn){var Jn=0.02/Math.abs(gl-yl);null!=Rn&&(Jn=Rn);var Ln=Math.abs(parseFloat(Mn)-parseFloat(Cn));return!!(Ln<Jn)}function Va(Mn,Cn){var Jn=Math.abs(parseFloat(Mn)-parseFloat(Cn));return Jn}function Ma(){this.type='',this.sid=hl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Mn){return this.type==Mn.type&&Qa(this.xs,Mn.xs)&&Qa(this.ys,Mn.ys)},this.addline=function(Mn,Cn,Rn,Jn,Ln,jn,Pn,An){this.type='L',this.size=Pn,this.color=An,this.xs=Mn,this.ys=Cn,this.zs=Rn,this.xe=Jn,this.ye=Ln,this.ze=jn},this.addbolt=function(Mn,Cn,Rn,Jn,Ln,jn,Pn){this.type='B',this.text=Pn,this.xs=Mn,this.ys=Cn,this.zs=Rn,this.xe=Jn,this.ye=Ln,this.ze=jn},this.addwater=function(Mn,Cn,Rn,Jn,Ln,jn,Pn,An){this.type='W',this.size=Jn,this.xs=Mn,this.ys=Cn,this.zs=Rn,null!==Ln&&(this.text=Ln),null!==jn&&(this.xe=jn),null!==Pn&&(this.fall=Pn),null!==An&&(this.angle=An)},this.addfall=function(Mn,Cn,Rn,Jn,Ln,jn){this.type='F',this.xs=Mn,this.ys=Cn,this.zs=Rn,this.angle=Jn,this.fall=Ln,this.size=null==jn?_e(Ra(Cn)):jn},this.addtext=function(Mn,Cn,Rn,Jn){this.type='T',this.text=Mn,this.xs=Cn,this.ys=Rn,this.zs=Jn}}function Ca(Mn){var Cn=parseFloat(2*(pmult*(Mn-parseFloat(wl))*vl/Vi));return Cn}function Ra(Mn){var Cn=parseFloat(pmult*Mn/(2*(vl/Vi))+wl);return Cn}function Ja(){var Mn=new Date,Cn=parseInt(Mn.getMonth()+1),Rn={date:Mn.getFullYear()+'-'+az(Cn)+'-'+az(Mn.getDate()),author:params.author};return Rn}function La(Mn){for(var Cn=[],Rn=[],Jn={pmult:pmult,pelperunit:1/(2*(vl/Vi)),zeropel:wl,pw:Mi,author:params.author,tunnel:Mn},Ln=new myxml(Jn),jn={type:'w',da:Ja(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},Pn={type:'t',da:Ja(),coords:[0,1],comment:'',fall:0},An={type:'f',da:Ja(),coords:[0,1],comment:'',angle:0,fall:0},En={type:'l',da:Ja(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},Tn={type:'q',da:Ja(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},On=0;On<allq.qar.length;On++){var Bn=allq.qar[On],In=Tn;In.da.author=Bn.author,In.da.date=sid2date(Bn.lastchange),In.coords=[Bn.ps,Bn.pe],In.QVal=[Bn.RQD,Bn.Jn,Bn.Jr,Bn.Ja,Bn.Jw,Bn.SRF,Bn.Q],In.bergart=Bn.bergart,In.comment=Bn.comment,In.color=Dt(Ce(Bn.bergart)),Ln.parseos(In)}for(var On=0;On<_l.length;On++)if(!_l[On].skip&&!isinarray(Rn,On)){var Gn=Le(On);if(!isinarray(Cn,Gn)){var Wn,Nn=Re(On),_n=-2<Gn?1:0;_n&&(Cn.push(Gn),Wn=allp.par[Gn]);var Hn,Un=_l[On];if('L'==Nn)if(Hn=En,Hn.da.author=Un.author,Hn.da.date=sid2date(Un.sid),Hn.ltype=Un.color[0],_n)Wn.isarea&&(Hn.ltype=5),Hn.coords=Wn.coords,Hn.comment=Wn.comment,Hn.bergart=Wn.bergart,Hn.color=Wn.color,Hn.width=Wn.width;else{for(var Xn=de(On),Yn=0;Yn<Xn.length;Yn++)Rn.push(Xn[Yn]);Hn.coords=ue(Xn)}'W'==Nn&&(Hn=jn,Hn.da.author=Un.author,Hn.da.date=sid2date(Un.sid),Hn.coords=[Un.xs,Un.ys],_n&&(Wn.comment&&(Hn.comment=Wn.comment),Wn.dsc&&(Hn.dsc=Wn.dsc),Wn.wdrip&&(Hn.drip=Wn.wdrip),Wn.wleak&&(Hn.leak=Wn.wleak))),'T'==Nn&&(Hn=Pn,Hn.da.author=Un.author,Hn.da.date=sid2date(Un.sid),Hn.coords=[Un.xs,Un.ys],Hn.comment=Un.text,Hn.fall=Un.fall),'B'==Nn&&(Hn=Pn,Hn.da.author=Un.author,Hn.da.date=sid2date(Un.sid),Hn.coords=[Un.xs,Un.ys],Hn.comment='B'),'F'==Nn&&(Hn=An,Hn.da.author=Un.author,Hn.da.date=sid2date(Un.sid),Hn.coords=[Un.xs,Un.ys],Hn.angle=Un.size?Un.angle:360-Un.angle,Hn.fall=Un.fall),Ln.parseos(Hn)}}return Ln.showstrout()}function ja(Mn,Cn){for(var Rn=[],Jn=[],Ln=JSON.parse(JSON.stringify(Mn)),jn=0;jn<Ln.length;jn++)if(!isinarray(Jn,jn)){var Pn=params.onlynew&&!Cn?Ln[jn].sid==hl:1;1<params.onlynew&&(Pn=Ln[jn].sid==params.onlynew?1:0);var An=1;if(params.onlycurpel&&!Cn&&!_a(Ra(Ln[jn].ys))){var En=de(jn);add2array(Jn,En),An=0}!Ln[jn].skip&&Pn&&An&&Rn.push(Ln[jn])}return Rn}function Pa(Mn){var Cn=0;null!=Mn&&(Cn=Mn);var Rn=ja(_l,Cn),Jn=new ge;Jn.lastchange=oman.changelist[params.onlynew],null==Jn.lastchange&&(Jn.lastchange=hl),Jn.zeropel=wl,Jn.pelperunit=vl*pmult,Jn.pw=Mi,Jn.pelstart=gl,Jn.pelend=yl,Jn.author=params.author,Jn.authors={},Jn.sid=hl,Jn.sids={},Jn.tunnel=params.tunnel;var Ln=new We;Cn?Ln.restore(allq,1):Ln.restore(allq,1,params.onlynew),Jn.qval=Ln;var jn=new Ge;jn.restore(allp,1,params.onlynew&&!Cn),Cn?jn.restore(allp,1):jn.restore(allp,1,params.onlynew),jn.cleanFromQ(),jn.y2pelcoords(),params.onlycurpel&&jn.cleanFromPel(),Jn.pval=jn;for(var Pn=yprev=cprev=sprev=-1e3,An=0;An<Rn.length;An++)Rn[An].ys=Ra(Rn[An].ys),Rn[An].ye=Ra(Rn[An].ye);for(var En,An=0;An<Rn.length;An++){En=Rn[An].author,null==Jn.authors[En]?Jn.authors[En]=[An]:Jn.authors[En].push(An);var Tn=Rn[An].sid;if(null==Jn.sids[Tn]?Jn.sids[Tn]=[An]:Jn.sids[Tn].push(An),'L'==Rn[An].type){if(Pn==Math.round(Rn[An].xs*qprec)&&yprev==Math.round(Rn[An].ys*qprec)&&cprev==Rn[An].color&&sprev==Rn[An].size){var On=[Math.round(Rn[An].xe*qprec),Math.round(Rn[An].ye*qprec)];Pn=Math.round(Rn[An].xe*qprec),yprev=Math.round(Rn[An].ye*qprec)}else{Pn=Math.round(Rn[An].xe*qprec),yprev=Math.round(Rn[An].ye*qprec),cprev=Rn[An].color,sprev=Rn[An].size;var On=[0,Math.round(Rn[An].xs*qprec),Math.round(Rn[An].ys*qprec),Rn[An].zs,Pn,yprev];6!=Rn[An].size&&On.push(Rn[An].size),'#000000'!=Rn[An].color&&On.push(Rn[An].color)}Jn.objdata.push(On)}if('W'==Rn[An].type){Pn=-1e3;var On=[1,Rn[An].xs*qprec,Rn[An].ys*qprec];0.5!=Rn[An].size&&On.push(Rn[An].size),Jn.objdata.push(On)}if('T'==Rn[An].type){Pn=-1e3;var Bn=Rn[An].text;1==Rn[An].fall&&(Bn='_pho_'+Bn),2==Rn[An].fall&&(Bn='_lab_'+Bn);var On=[2,Rn[An].xs*qprec,Rn[An].ys*qprec,Rn[An].zs,Bn];Jn.objdata.push(On)}if('F'==Rn[An].type){if(Pn=-1e3,''!=Rn[An].color)var On=[3,Rn[An].xs*qprec,Rn[An].ys*qprec,Rn[An].angle,Rn[An].fall,Rn[An].size,Rn[An].color];else var On=[3,Rn[An].xs*qprec,Rn[An].ys*qprec,Rn[An].angle,Rn[An].fall,Rn[An].size];Jn.objdata.push(On)}if('B'==Rn[An].type){Pn=-1e3;var On=[4,Rn[An].xs*qprec,Rn[An].ys*qprec,Rn[An].zs,Rn[An].xe*qprec,Rn[An].ye*qprec,Rn[An].ze,Rn[An].text];Jn.objdata.push(On)}}var In=Object.keys(Jn.authors).length;if(1==In){var Gn=Fa(0,Jn.authors);null!=Gn&&(Jn.author=Fa(0,Jn.authors)),null==Jn.authors}var Nn=Object.keys(Jn.sids).length;if(1==Nn){var Gn=Fa(0,Jn.sids);null!=Gn&&(Jn.sid=Fa(0,Jn.sids)),null==Jn.sids}for(var _n in Jn.chlist={},Jn.sids){var En=oman.changelist[_n];console.log('Element of changelist',_n,En),null!=En&&(Jn.chlist[_n]=En)}return console.log('Saved change list',Jn.chlist),0==Jn.qval.qar.length&&console.log('No Q to save'),0==Jn.pval.par.length&&console.log('No Props to save'),0==Jn.objdata.length&&console.log('No registrations to save'),0==Jn.objdata.length&&0==Jn.pval.par.length&&0==Jn.qval.qar.length&&(Jn=0),Jn}function Aa(Mn,Cn){if(Ds=1,renderblock=1,Cn>=Mn.files.length)return ji.value=null,allq.update(),Sa(),renderblock=0,$(),void(Ds=0);var Rn=new FileReader;Rn.onload=function(Jn){return 1==Mn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(Jn.target.result),Ds=0,void(renderblock=0)):void(Da(Jn.target.result),console.log('Done reading ',Cn),Aa(ji,Cn+1))},Rn.readAsText(Mn.files[Cn])}function Ta(){hi.visible=!1,Il=yp=zp=-1e3,Di=-1,gi.visible=!1}function Oa(Mn,Cn){var Jn=180*(Math.atan2(Mn-_l[_l.length-1].xs,Cn-_l[_l.length-1].ys)/Math.PI);Jn=Math.round(Jn),0>Jn&&(Jn=360+Jn),Kl.rotation=Math.round(1e3*(-Math.PI/180*Jn))/1e3,params.angle=Jn,_l[_l.length-1].angle=Jn,ns.updateDisplay(),oman.updchangelist(_l[_l.length-1].sid)}function Ba(Mn,Cn,Rn,Jn,Ln,jn){var Pn=new THREE.CircleGeometry(Jn,32,Math.PI/4,2.12*Math.PI),An=new THREE.Line(Pn,new THREE.LineBasicMaterial({color:jn,linewidth:Ln}));return An.position.set(Mn,Cn,Rn),An}function Ia(Mn,Cn,Rn){var Ln=0;null!=Cn&&(Ln=Dt(Cn,1));var jn='object'==typeof Rn?Rn.val:1,Pn=new THREE.TextSprite({textSize:0.25*Li*jn,redrawInterval:1e7,texture:{text:Mn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Ln,fog:!1}});return 15!=jn&&Ql.push(Pn),Pn.position.set(0,0,1),fcp&&(setTimeout(function(){$()},100),fcp=0),Pn}function Na(){Te(),De(),Ae()}function _a(Mn){var Cn=picparams.ps,Rn=picparams.pe;if(0<pmult){if(Mn>=Cn&&Mn<=Rn)return!0;}else if(Mn>=Rn&&Mn<=Cn)return!0;return!1}function Wa(Mn,Cn,Rn){var Jn=Cn,Ln=Rn;if(Rn>Cn){if(Mn>=Jn&&Mn<=Ln)return!0;}else if(Mn>=Ln&&Mn<=Jn)return!0;return!1}(function(){try{var Mn=new FormData,Cn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Cn.open('get',baseaddr+'getip.php',!0),Cn.send('')}catch(Rn){console.log(Rn)}})();var Ha=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),Xa=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),Ya=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),Ka,Za;this.getrs=function(){return Ka},this.callresultstring=function(Mn){ee(Mn)},this.getrp=function(){return Za},this.callresultpic=function(Mn){ie(Mn)},this.loadlines=function(Mn){Da(Mn),allq.update(),Sa(),$()},this.setauthor=function(Mn){params.author=Mn,ns.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Mn,Cn){console.log('novaxmlto to be done'),Cn},this.getnxml=function(){return'to be xml text'},this.show3d=function(){it()},this.show2d=function(){rt()};var el=S.picsizex,il=S.picsizey,sl=S.picadress,rl=sl,dl=S.tung,ul=S.ling,hl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,picdb.ldb();var gl=S.pelstart,yl=S.pelend,fl=Math.abs(parseInt(gl)-parseInt(yl)),vl=50;11>fl&&(vl=100),6>fl&&(vl=200),il=vl*fl;var wl=S.zeropel,kl=S.picpack,Sl=!1,zl=el,Fl=il,Dl,Ql=[];container=condiv();var Vl,Ml=new THREE.Raycaster,Cl=new THREE.Vector2,Jl=0,Ll=0,jl=0,El=[],Il=yp=zp=-1e3,Gl=yp2d=zp2d=-1e3,Nl=[],_l=[],Wl='Line';oman=new M;var Ul=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Hl=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Mn,Cn,Rn){this.idx.push(Mn),this.type.push(Cn),this.remprev.push(Rn),this.xl.push(0),this.yl.push(0)},this.addMove=function(Mn,Cn,Rn,Jn,Ln){this.idx.push(Mn),this.type.push(Cn),this.remprev.push(Rn),this.xl.push(Jn),this.yl.push(Ln)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},Xl,Yl,Kl,li,ii,si=0,oi=lastmovey=-1e3,ri=0;Detector.canvas||alert('Browser does not support canvas 3d'),Vl=new THREE.Scene;var pi=new THREE.Scene,ci=new THREE.Scene,ui=Vl,hi=new THREE.Object3D,gi=new THREE.Object3D,mi=new THREE.Object3D,yi=new THREE.Object3D,fi=new THREE.Object3D,vi=new THREE.Object3D,bi=new THREE.Object3D,xi=new THREE.Object3D,ki=new THREE.Object3D;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Vl.add(bi),Vl.add(xi),Vl.add(ki);var Si=new THREE.Object3D,zi=new THREE.Object3D,Fi=new THREE.Object3D,Di=-1;hi.visible=!1,gi.visible=!1,pmult=gl<yl?1:-1;var Vi=200,Mi=el/200,Ci=il/Vi,Ri=0,Ji=1,Li=1,ji=document.createElement('input');document.body.appendChild(ji),ji.type='file',ji.accept='.txt',ji.multiple=!0,ji.style.display='none',ji.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Mn=this.files[0].name,Cn=pelfromfname(Mn);params.overridepel&&saveifokdist(Cn[0],Cn[1]),('t'==Mn[Mn.length-1]||'T'==Mn[Mn.length-1])&&Aa(this,0)};var Pi=document.createElement('input');document.body.appendChild(Pi),Pi.type='file',Pi.style.display='none',Pi.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Mn=this.files[0].name;('g'==Mn[Mn.length-1]||'G'==Mn[Mn.length-1])&&H(this)};var Ai=new Image,Ei=document.getElementById('linbtn'),Ti=document.getElementById('watbtn'),Oi=document.getElementById('txtbtn'),Bi=document.getElementById('falbtn'),Ii=document.getElementById('selbtn'),Gi=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(Dt(Ya,1));var Ni,_i;z();var Wi=new THREE.Vector2(Ni,_i);renderer.setSize(Ni,_i),document.getElementById(h).appendChild(renderer.domElement);var Ui=document.getElementById(h).offsetTop,Hi=document.getElementById(h).offsetLeft,Xi=Ni/_i,Yi=2.5*Ci*Math.sqrt(2.28/(Ci/Mi)),Ki=Yi;Vl.add(mi),Vl.add(Si),Vl.add(Fi),Vl.add(zi),Vl.add(fi),Vl.add(vi),Vl.add(yi),camera=new THREE.OrthographicCamera(-Yi*Xi/2,Yi*Xi/2,Ki/2,-Ki/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var Zi=1;controls.target.set(0,0,0),camera.position.set(0,0,Zi);camera.zoom;controls.addEventListener('change',function(){$t(1)}),controls.addEventListener('end',function(){$t(1)}),cameraFix=new THREE.OrthographicCamera(-Yi*Xi/2,Yi*Xi/2,Ki/2,-Ki/2,-5e3,5e3);var as,ls;ya(sl,0),function(){var Mn=0.07*Li,Cn=0.14*Li,Rn=G(-Mn,-Mn,10,Mn,Mn,10,8*Li,'#000000'),Jn=G(Mn,-Mn,10,-Mn,Mn,10,8*Li,'#000000');hi.add(Rn,Jn),Vl.add(hi);var Ln=G(-Cn,-Cn,10,Cn,-Cn,10,5*Li,'#000000'),jn=G(Cn,-Cn,10,Cn,Cn,10,5*Li,'#0000ff'),Pn=G(Cn,Cn,10,-Cn,Cn,10,5*Li,'#ff0000'),An=G(-Cn,Cn,10,-Cn,-Cn,10,5*Li,'#00ff00');gi.add(Ln,jn,Pn,An),Vl.add(gi)}();var is=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],ss=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],ns=new dat.GUI({autoPlace:!1});ns.domElement.id='guipos',ns.close(),container.appendChild(ns.domElement);var fs,ws,ks,Ss,Fs={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Ds=0;android&&setInterval(function(){gt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){V(),yt()})},savexml:function(){wt(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'Some text',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){tt(),$();var Mn=renderer.domElement.toDataURL(),Cn=new Date,Rn='';Rn=Rn+'geo'+Cn.getHours()+'h'+Cn.getMinutes()+'m'+Cn.getSeconds()+'s.png',bn(Mn,Rn),ut(),lsc=1,Sa(),$()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){Ii.value='Select',wa('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Mn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Mn,function(){params.onlynew=!1,disassemble(),ns.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){V()})},load:function(){Da(params.textsave),$()},go3d:it,go2d:rt,getflist:function(){bt()},add5m:function(){dt()},resetcam:function(){ns.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Zi),Ta(),$()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){ji.click()}):ji.click()},overridepel:!0,openfoto:function(){Pi.click()},makelab:function(){Y(Di,qa.labtest,2),ns.updateDisplay()},dummy:function(){},apply:function(){Te()},applyP:function(){Be()},qedit:function(){},editRQD:function(){Ee(),rqdmenu(Ts,container,Na)},editJn:function(){Ee(),jnmenu(Ts,container,Na)},editJr:function(){Ee(),jrmenu(Ts,container,Na)},editJa:function(){Ee(),jamenu(Ts,container,Na)},editJw:function(){Ee(),jwmenu(Ts,container,Na)},editSRF:function(){Ee(),srfmenu(Ts,container,Na)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0],lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Mn=gt();V();var Cn=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Cn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==sl?ha(picparams.ps,picparams.pe):ua(picparams.ps,picparams.pe),Mn&&yt(),renderblock=0,$(),wa('Line'),Ii.value='Select'},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Qs={showdb:function(){var Mn=function(){for(var Rn=0,Jn=0;Jn<newdb.files.length;Jn++)newdb.files[Jn].ischosen&&!newdb.files[Jn].toskip&&Rn++;if(Rn){if(params.overridepel){var Ln=getchosenpels(newdb),jn=Ln[0],Pn=Ln[1];picparams.ps=jn,picparams.pe=Pn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),ha(picparams.ps,picparams.pe)}var An=0;renderblock=1;for(var En,Jn=0;Jn<newdb.files.length;Jn++)En=newdb.files[Jn],En.ischosen&&!newdb.files[Jn].toskip&&(An++,Da(En.savedata));Sa(),allq.update(),renderblock=0,$(),newdb.uncheckall(),wa('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Mn(),ns.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Mn()}):(Mn(),ns.updateDisplay())})},showpicdb:function(){dbpictable(container,Vs)},newblank:function(){ua(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Mn in picdb.sortbytime(),picdb.files)if(!picdb.files[Mn].toskip){picdb.files[Mn].ischosen=1;break}Vs(1)})})};var Vs=function(Mn){var Cn=getchosenpels(picdb);console.log(Cn);var Rn=Cn[0],Jn=Cn[1],Ln=Cn[2];picparams.ps=Rn,picparams.pe=Jn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Mn?getbypl(picparams.ps,picparams.pe):ha(picparams.ps,picparams.pe,Ln),picdb.uncheckall()},Ms=Qe(fgui),Cs=Se('Start!');Cs.setAttribute('class','inguib but1gui aguibut'),Cs.onclick=function(){myaddfunc.openblank()},Ms.appendChild(Cs);var Rs=fgui.add(params,'dummy').name('').__li,Ms=Qe(fgui),Cs=Se('Flip pic');Cs.setAttribute('class','inguib but2gui'),Cs.onclick=function(){myaddfunc.flip()},Ms.appendChild(Cs),Cs=Se('Add 5m'),Cs.setAttribute('class','inguib but2gui'),Cs.onclick=function(){params.add5m()},Ms.appendChild(Cs);var Ms=Qe(fgui),Cs=Se('MWDdb');Cs.setAttribute('class','inguib but2gui aguibut'),Cs.onclick=function(){Qs.showpicdb()},Ms.appendChild(Cs),Cs=Se('Open geom'),Cs.setAttribute('class','inguib but2gui aguibut'),Cs.onclick=function(){picparams.openf()},Ms.appendChild(Cs);var Ms=Qe(fgui),Cs=Se('Go 2d');Cs.setAttribute('class','inguib but2gui'),Cs.onclick=function(){params.go2d()},Ms.appendChild(Cs),Cs=Se('Go 3d'),Cs.setAttribute('class','inguib but2gui'),Cs.onclick=function(){params.go3d()},Ms.appendChild(Cs),fgui.add(params,'dummy').name(''),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),It()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){Sa(),$()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){St(gl,yl),$()}),P(gl,yl),St(gl,yl);var Js=new THREE.TextureLoader;Js.crossOrigin='anonymous';var Ls=Js.load(spcline),js=Js.load(spcline1,function(){js.wrapS=js.wrapT=THREE.RepeatWrapping,js.offset.set(0,0),js.repeat.set(1,1)}),Ps=Js.load(spcline2,function(){Ps.wrapS=Ps.wrapT=THREE.RepeatWrapping,Ps.offset.set(0,0),Ps.repeat.set(1,1)}),Es=new Ma,Ts=new Ue,Os=new Ie;Ts.getQ(),allq=new We,allp=new Ge;var Bs=chosenp=-2;wa('Line'),fa(gl,yl,-1);var Is=0,Gs=new Hammer(Ei);Ei.onclick=function(){if(Is)return void(Is=0);var Cn=0,Rn=ns.closed;'Line'==params.linetype&&(Cn=1),wa('Line'),F(this),Cn&&L(),Rn&&ns.close(),ns.removeFolder(qa.qval),ns.removeFolder(qa.setproperties),Ii.value='Select'},(iOS||android)&&Gs.on('press',function(){Ei.click(),Is=1,setTimeout(function(){Is=0},250)}),Gs.get('press').set({threshold:100,time:3});var Ns=new Hammer(Ti);Ti.onclick=function(){return Is?void(Is=0):void(wa('Water'),Ii.value='Select',F(this))},(iOS||android)&&Ns.on('press',function(){Ti.click(),Is=1,setTimeout(function(){Is=0},250)}),Ns.get('press').set({threshold:100,time:3});var _s=new Hammer(Oi);Oi.onclick=function(){wa('Text'),Ii.value='Select',F(this)},(iOS||android)&&_s.on('press',function(){Oi.click(),Is=1,setTimeout(function(){Is=0},250)}),_s.get('press').set({threshold:100,time:3});var Ws=new Hammer(Bi);Bi.onclick=function(){return Sl?void Kt():void(wa('Fall'),Ii.value='Select',F(this))},(iOS||android)&&Ws.on('press',function(){Bi.click(),Is=1,setTimeout(function(){Is=0},250)}),Ws.get('press').set({threshold:100,time:3});var Us=new Hammer(Gi);Gi.onclick=function(){android&&he(),Ii.value='Select'},Us.on('press',function(){android||(he(),Ii.value='Select',Is=1,setTimeout(function(){Is=0},250))}),Us.get('press').set({threshold:100,time:3});var Hs=0,Xs=new Hammer(Ii);android&&(Ii.onclick=function(){Hs||Ys(1)}),Xs.on('press',function(){Ys(0),Hs=1,setTimeout(function(){Hs=0},250)}),Xs.get('press').set({threshold:100,time:3});var Ys=function(){return'Select'==Ii.value?(Ii.value='Group',void wa('Select')):'One'==Ii.value?void(Ii.value='Group'):'Group'==Ii.value?void(Ii.value='One'):void 0};Ee();Vl.children.length;document.addEventListener('keydown',function(Mn){switch(Mn.keyCode){case 65:$t();break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',ut,!1);var Zs=null,$s=new Hammer(renderer.domElement),en=lasty=-1e3,tn=firsty=firstz=-1e3,ln=endy=-1e3;$s.on('press',function(Mn){ri=new Date().getTime(),C(Mn),Sa()}),$s.on('pan',function(Mn){if('Line'==params.linetype){var Cn=(en-Mn.center.x+Hi)*(en-Mn.center.x+Hi)+(lasty-Mn.center.y+Ui)*(lasty-Mn.center.y+Ui);Cn>sensivity*sensivity&&C(Mn)}if('Select'==params.linetype){if(Jl)return;var Cn=(en-Mn.center.x+Hi)*(en-Mn.center.x+Hi)+(lasty-Mn.center.y+Ui)*(lasty-Mn.center.y+Ui),Rn=Mn.velocityX*Mn.velocityX+Mn.velocityY*Mn.velocityY;20<Rn&&(oe(),Jl=1),params.move&&5>Rn&&(1e4<Cn||params.movestart)&&(C(Mn),params.movestart=!0)}'Bolt'==params.linetype&&C(Mn),'Fall'==params.linetype&&C(Mn)}),$s.on('panstart',function(){Ll=1,jl=1,Jl=0,params.move=!0,params.movestart=!1,!Sl||controls.enableRotate}),$s.on('panend',function(){'Line'==params.linetype&&(Ta(),ri=new Date().getTime()),params.move=!1,Sa(),$(),Jl=0,Ll=0,jl=0,Sl}),$s.on('pinchstart',function(){clearTimeout(Zs),Zs=null,Ta()}),D();$();var Js=new THREE.TextureLoader;Js.crossOrigin='anonymous';var rn=Js.load(kl.imdrop),dn=new THREE.SpriteMaterial({map:rn,color:16777215}),cn=Js.load(kl.fallMap),un=Js.load(kl.fallMapA180),hn=Js.load(kl.fallMapF0),gn=Js.load(imflask),mn=Js.load(imphoto),yn=new THREE.SpriteMaterial({map:gn}),fn=new THREE.SpriteMaterial({map:mn}),bn=function(Mn,Cn){var Rn=document.createElement('a');'string'==typeof Rn.download?(document.body.appendChild(Rn),Rn.download=Cn,Rn.href=Mn,Rn.click(),document.body.removeChild(Rn)):location.replace(uri)};var xn=function(Mn,Cn){var Rn=new THREE.Vector3().subVectors(Cn,Mn),Jn=new THREE.Matrix4;Jn.lookAt(Mn,Cn,new THREE.Object3D().up);var Ln=new THREE.Matrix4;Ln.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),Jn.multiply(Ln);var jn=new THREE.CylinderGeometry(0.1,0.1,Rn.multiplyScalar(0.3).length(),48,1),Pn=new THREE.Mesh(jn,new THREE.MeshBasicMaterial({color:0}));Pn.applyMatrix(Jn);var An=new THREE.Vector3().addVectors(Mn,Rn.multiplyScalar(0.5));return Pn.position.set(An.x,An.y,An.z),Pn},wn=function(Mn,Cn){var Rn,Jn,Ln,jn,Pn,An,En,Tn,On,Bn,In,Gn,Nn,_n;for(Nn=[],En=Mn.geometry.faceVertexUvs[0],Tn=Mn.geometry.faces,On=Mn.geometry.vertices,Bn=new THREE.Matrix4,In=new THREE.Matrix4,_n=new THREE.Matrix4,pi.updateMatrixWorld(!0),jn=0;jn<En.length;jn++)if(Pn=En[jn],An=Tn[jn],et(Pn,Cn)){Rn=On[An.a].clone().applyMatrix4(Mn.matrixWorld),Jn=On[An.b].clone().applyMatrix4(Mn.matrixWorld),Ln=On[An.c].clone().applyMatrix4(Mn.matrixWorld),Bn.set(Rn.x,Rn.y,Rn.z,0,Jn.x,Jn.y,Jn.z,0,Ln.x,Ln.y,Ln.z,0,0,0,0,1),In.set(Pn[0].x,Pn[0].y,0,1,Pn[1].x,Pn[1].y,0,1,Pn[2].x,Pn[2].y,0,1,0,0,1,0),In.getInverse(In),Bn.multiplyMatrices(In,Bn),Bn.elements=Ke(Bn),Bn.transpose(),Gn=new THREE.Vector3(Cn.x,Cn.y,1);var Wn=Gn.applyMatrix4(Bn);Nn.push(Wn),Nn.push(An.normal)}return Nn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,ns.updateDisplay()},syncfun=function(Cn,Rn){var Jn=function(){putdbf(Cn),hl=getsessionid()},Ln=function(){mt.end('Merging'),newdb.syncall(),Jn(),console.log('Skipped files'),console.log(newdb.showskipped())},jn=function(An){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(An,Ln)})};getver(function(An){var En=An[0];console.log('localver=',newdb.getsid(),'onlinever',En);var Tn=!0;for(var On in newdb.files)Tn=Tn&&newdb.files[On].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=En||!Tn||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+En,getdbf(jn)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Rn&&Rn())})};getbypl=function(Cn,Rn){var Jn=normPel(Cn,Rn),Ln=Jn[0],jn=Jn[1],Pn=Ln,An=jn,En=newdb.sorted;newdb.sortbypelasc();var Tn=[],On=JSON.parse(JSON.stringify(newdb.files));for(var Bn in On){var In=On[Bn];if(!In.toskip){var Gn=normPel(In.ps,In.pe);numintersect(Ln,jn,Gn[0],Gn[1])&&(Pn=Math.min(Pn,Ln,jn,Gn[0],Gn[1]),An=Math.max(An,Ln,jn,Gn[0],Gn[1]),Tn.push(In.savedata))}}for(var Bn in newdb.sortbytime(),ha(Pn,An),renderblock=1,Tn)Da(Tn[Bn]);Sa(),allq.update(),renderblock=0,$()};var Sn,Fn;It();var Dn=[],Qn,Vn;cutpels=function(){params.onlycurpel=!0;var Mn=Pa();V(),Da(Mn),Sa(),allq.update(),$(),params.onlycurpel=!1},disassemble=function(){var Mn=Pa();console.log('Sids are',Mn.sids);var Cn=[];for(var Rn in Mn.sids)Cn.push(Rn);for(var Jn in Cn)params.onlynew=parseInt(Cn[Jn]),Jn==Cn.length-1?ee(1):ee(1,1);params.onlynew=0,ae()},dat.GUI.prototype.removeFolder=function(Mn){var Cn=this.__folders[Mn];Cn&&(Cn.close(),this.__ul.removeChild(Cn.domElement.parentNode),delete this.__folders[Mn],this.onResize())},S.callback()}